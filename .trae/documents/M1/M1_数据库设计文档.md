# 部门地图 M1 阶段数据库设计文档

***

**文档版本**: M1.1.0\
**创建日期**: 2024-09-7\
**最后更新**: 2024-09-7\
**更新内容**: 完善索引设计和数据约束规则
-----------------------

## 1. 数据库概述

### 1.1 基础信息

* **数据库类型**: PostgreSQL 15+

* **字符集**: UTF-8

* **时区**: UTC

* **连接池**: 最大20个连接

* **备份策略**: 每日全量备份 + 实时WAL备份

### 1.2 设计原则

1. **数据一致性**: 使用逻辑外键约束，避免物理外键
2. **性能优化**: 合理设计索引，支持高频查询
3. **扩展性**: 预留字段和表结构，支持未来功能扩展
4. **安全性**: 敏感数据加密存储，实现行级安全
5. **可维护性**: 清晰的命名规范，完整的注释文档

## 2. 数据模型设计

### 2.1 实体关系图

```mermaid
erDiagram
    USERS ||--o{ EMPLOYEES : manages
    DEPARTMENTS ||--o{ EMPLOYEES : contains
    DEPARTMENTS ||--o{ DESKS : has
    DEPARTMENTS ||--o{ MAPS : uses
    EMPLOYEES ||--o{ ASSIGNMENTS : assigned_to
    DESKS ||--o{ ASSIGNMENTS : assigned_from
    USERS ||--o{ USER_SESSIONS : has
    EMPLOYEES ||--o{ PRESENCE_LOGS : tracks
    
    USERS {
        int id PK
        string username UK
        string password_hash
        string name
        string email
        enum role
        timestamp created_at
        timestamp updated_at
    }
    
    DEPARTMENTS {
        int id PK
        string name UK
        string floor
        string map_id
        json metadata
        timestamp created_at
        timestamp updated_at
    }
    
    MAPS {
        string id PK
        enum type
        string url
        int dept_id FK
        json metadata
        timestamp created_at
    }
    
    EMPLOYEES {
        int id PK
        string name
        int dept_id FK
        string title
        string email
        string phone
        json metadata
        timestamp created_at
        timestamp updated_at
    }
    
    DESKS {
        string id PK
        string label
        int dept_id FK
        int x
        int y
        int w
        int h
        json metadata
        timestamp created_at
    }
    
    ASSIGNMENTS {
        int id PK
        int employee_id FK
        string desk_id FK
        boolean active
        timestamp assigned_at
        timestamp unassigned_at
    }
    
    USER_SESSIONS {
        string id PK
        int user_id FK
        string refresh_token
        timestamp expires_at
        timestamp created_at
    }
    
    PRESENCE_LOGS {
        int id PK
        int employee_id FK
        enum status
        string desk_id
        json metadata
        timestamp created_at
    }
```

### 2.2 核心实体说明

#### 2.2.1 用户表 (users)

存储系统用户信息，用于认证和权限管理。

#### 2.2.2 部门表 (departments)

存储部门基础信息，是系统的核心组织单位。

#### 2.2.3 地图表 (maps)

存储地图文件信息，支持多种格式的地图数据。

#### 2.2.4 员工表 (employees)

存储员工基础信息，与部门和工位关联。

#### 2.2.5 工位表 (desks)

存储工位的位置和尺寸信息，是地图上的可视化元素。

#### 2.2.6 分配表 (assignments)

记录员工与工位的分配关系，支持历史记录。

#### 2.2.7 会话表 (user\_sessions)

管理用户登录会话和刷新令牌。

#### 2.2.8 在线状态日志表 (presence\_logs)

记录员工在线状态变化历史。

## 3. 表结构定义

### 3.1 用户表 (users)

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(255),
    role VARCHAR(20) DEFAULT 'user' CHECK (role IN ('admin', 'user')),
    active BOOLEAN DEFAULT true,
    last_login_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email) WHERE email IS NOT NULL;
CREATE INDEX idx_users_active ON users(active);

-- 注释
COMMENT ON TABLE users IS '系统用户表';
COMMENT ON COLUMN users.username IS '用户名，唯一标识';
COMMENT ON COLUMN users.password_hash IS '密码哈希值';
COMMENT ON COLUMN users.role IS '用户角色：admin-管理员，user-普通用户';
```

### 3.2 部门表 (departments)

```sql
CREATE TABLE departments (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    floor VARCHAR(50),
    map_id VARCHAR(100),
    description TEXT,
    metadata JSONB DEFAULT '{}',
    active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_departments_name ON departments(name);
CREATE INDEX idx_departments_floor ON departments(floor) WHERE floor IS NOT NULL;
CREATE INDEX idx_departments_active ON departments(active);
CREATE INDEX idx_departments_metadata ON departments USING GIN(metadata);

-- 注释
COMMENT ON TABLE departments IS '部门信息表';
COMMENT ON COLUMN departments.name IS '部门名称，唯一';
COMMENT ON COLUMN departments.floor IS '所在楼层';
COMMENT ON COLUMN departments.map_id IS '关联地图ID';
COMMENT ON COLUMN departments.metadata IS '扩展元数据，JSON格式';
```

### 3.3 地图表 (maps)

```sql
CREATE TYPE map_type AS ENUM ('svg', 'png', 'json');

CREATE TABLE maps (
    id VARCHAR(100) PRIMARY KEY,
    type map_type NOT NULL,
    url VARCHAR(500) NOT NULL,
    dept_id INTEGER,
    file_size BIGINT,
    file_hash VARCHAR(64),
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_maps_dept_id ON maps(dept_id);
CREATE INDEX idx_maps_type ON maps(type);
CREATE INDEX idx_maps_file_hash ON maps(file_hash) WHERE file_hash IS NOT NULL;

-- 注释
COMMENT ON TABLE maps IS '地图文件信息表';
COMMENT ON COLUMN maps.type IS '地图类型：svg, png, json';
COMMENT ON COLUMN maps.url IS '地图文件访问URL';
COMMENT ON COLUMN maps.file_size IS '文件大小（字节）';
COMMENT ON COLUMN maps.file_hash IS '文件哈希值，用于去重';
```

### 3.4 员工表 (employees)

```sql
CREATE TABLE employees (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    dept_id INTEGER NOT NULL,
    employee_no VARCHAR(50),
    title VARCHAR(100),
    email VARCHAR(255),
    phone VARCHAR(20),
    avatar_url VARCHAR(500),
    metadata JSONB DEFAULT '{}',
    active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_employees_name ON employees(name);
CREATE INDEX idx_employees_dept_id ON employees(dept_id);
CREATE INDEX idx_employees_employee_no ON employees(employee_no) WHERE employee_no IS NOT NULL;
CREATE INDEX idx_employees_email ON employees(email) WHERE email IS NOT NULL;
CREATE INDEX idx_employees_active ON employees(active);
CREATE INDEX idx_employees_search ON employees USING GIN(to_tsvector('simple', name || ' ' || COALESCE(title, '') || ' ' || COALESCE(email, '')));

-- 注释
COMMENT ON TABLE employees IS '员工信息表';
COMMENT ON COLUMN employees.employee_no IS '员工工号';
COMMENT ON COLUMN employees.title IS '职位/职称';
COMMENT ON COLUMN employees.avatar_url IS '头像URL';
```

### 3.5 工位表 (desks)

```sql
CREATE TABLE desks (
    id VARCHAR(100) PRIMARY KEY,
    label VARCHAR(50) NOT NULL,
    dept_id INTEGER NOT NULL,
    x INTEGER NOT NULL CHECK (x >= 0),
    y INTEGER NOT NULL CHECK (y >= 0),
    w INTEGER DEFAULT 60 CHECK (w > 0),
    h INTEGER DEFAULT 40 CHECK (h > 0),
    rotation INTEGER DEFAULT 0 CHECK (rotation >= 0 AND rotation < 360),
    metadata JSONB DEFAULT '{}',
    active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_desks_dept_id ON desks(dept_id);
CREATE INDEX idx_desks_label ON desks(label);
CREATE INDEX idx_desks_position ON desks(x, y);
CREATE INDEX idx_desks_active ON desks(active);

-- 空间索引（用于范围查询）
CREATE INDEX idx_desks_bounds ON desks((x + w), (y + h));

-- 注释
COMMENT ON TABLE desks IS '工位信息表';
COMMENT ON COLUMN desks.label IS '工位标签/编号';
COMMENT ON COLUMN desks.x IS 'X坐标';
COMMENT ON COLUMN desks.y IS 'Y坐标';
COMMENT ON COLUMN desks.w IS '宽度';
COMMENT ON COLUMN desks.h IS '高度';
COMMENT ON COLUMN desks.rotation IS '旋转角度（度）';
```

### 3.6 分配表 (assignments)

```sql
CREATE TABLE assignments (
    id SERIAL PRIMARY KEY,
    employee_id INTEGER NOT NULL,
    desk_id VARCHAR(100) NOT NULL,
    active BOOLEAN DEFAULT true,
    assigned_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    unassigned_at TIMESTAMP WITH TIME ZONE,
    assigned_by INTEGER,
    notes TEXT,
    
    -- 确保同一时间一个工位只能分配给一个员工
    CONSTRAINT unique_active_desk_assignment 
        EXCLUDE (desk_id WITH =) WHERE (active = true),
    
    -- 确保同一时间一个员工只能分配一个工位
    CONSTRAINT unique_active_employee_assignment 
        EXCLUDE (employee_id WITH =) WHERE (active = true)
);

-- 索引
CREATE INDEX idx_assignments_employee_id ON assignments(employee_id);
CREATE INDEX idx_assignments_desk_id ON assignments(desk_id);
CREATE INDEX idx_assignments_active ON assignments(active);
CREATE INDEX idx_assignments_assigned_at ON assignments(assigned_at DESC);
CREATE INDEX idx_assignments_assigned_by ON assignments(assigned_by) WHERE assigned_by IS NOT NULL;

-- 注释
COMMENT ON TABLE assignments IS '工位分配记录表';
COMMENT ON COLUMN assignments.active IS '是否为当前有效分配';
COMMENT ON COLUMN assignments.assigned_by IS '分配操作人ID';
COMMENT ON COLUMN assignments.notes IS '分配备注';
```

### 3.7 用户会话表 (user\_sessions)

```sql
CREATE TABLE user_sessions (
    id VARCHAR(128) PRIMARY KEY,
    user_id INTEGER NOT NULL,
    refresh_token VARCHAR(255) NOT NULL,
    user_agent TEXT,
    ip_address INET,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_used_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_user_sessions_user_id ON user_sessions(user_id);
CREATE INDEX idx_user_sessions_expires_at ON user_sessions(expires_at);
CREATE INDEX idx_user_sessions_refresh_token ON user_sessions(refresh_token);

-- 注释
COMMENT ON TABLE user_sessions IS '用户会话管理表';
COMMENT ON COLUMN user_sessions.refresh_token IS '刷新令牌';
COMMENT ON COLUMN user_sessions.user_agent IS '用户代理信息';
COMMENT ON COLUMN user_sessions.ip_address IS '客户端IP地址';
```

### 3.8 在线状态日志表 (presence\_logs)

```sql
CREATE TYPE presence_status AS ENUM ('online', 'offline', 'busy', 'away');

CREATE TABLE presence_logs (
    id BIGSERIAL PRIMARY KEY,
    employee_id INTEGER NOT NULL,
    status presence_status NOT NULL,
    desk_id VARCHAR(100),
    session_id VARCHAR(128),
    ip_address INET,
    user_agent TEXT,
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 分区表（按月分区）
CREATE TABLE presence_logs_y2024m01 PARTITION OF presence_logs
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

-- 索引
CREATE INDEX idx_presence_logs_employee_id ON presence_logs(employee_id);
CREATE INDEX idx_presence_logs_created_at ON presence_logs(created_at DESC);
CREATE INDEX idx_presence_logs_status ON presence_logs(status);
CREATE INDEX idx_presence_logs_desk_id ON presence_logs(desk_id) WHERE desk_id IS NOT NULL;

-- 注释
COMMENT ON TABLE presence_logs IS '员工在线状态日志表';
COMMENT ON COLUMN presence_logs.status IS '状态：online-在线，offline-离线，busy-忙碌，away-离开';
COMMENT ON COLUMN presence_logs.session_id IS '关联的会话ID';
```

## 4. 视图定义

### 4.1 部门统计视图

```sql
CREATE VIEW department_stats AS
SELECT 
    d.id,
    d.name,
    d.floor,
    COUNT(DISTINCT e.id) as total_employees,
    COUNT(DISTINCT CASE WHEN e.active THEN e.id END) as active_employees,
    COUNT(DISTINCT desk.id) as total_desks,
    COUNT(DISTINCT a.desk_id) as occupied_desks,
    COUNT(DISTINCT desk.id) - COUNT(DISTINCT a.desk_id) as vacant_desks,
    ROUND(
        COUNT(DISTINCT a.desk_id)::DECIMAL / NULLIF(COUNT(DISTINCT desk.id), 0) * 100, 
        2
    ) as occupancy_rate
FROM departments d
LEFT JOIN employees e ON d.id = e.dept_id
LEFT JOIN desks desk ON d.id = desk.dept_id AND desk.active = true
LEFT JOIN assignments a ON desk.id = a.desk_id AND a.active = true
WHERE d.active = true
GROUP BY d.id, d.name, d.floor;

COMMENT ON VIEW department_stats IS '部门统计信息视图';
```

### 4.2 员工工位视图

```sql
CREATE VIEW employee_desk_view AS
SELECT 
    e.id as employee_id,
    e.name as employee_name,
    e.title,
    e.email,
    d.id as dept_id,
    d.name as dept_name,
    d.floor,
    desk.id as desk_id,
    desk.label as desk_label,
    desk.x,
    desk.y,
    desk.w,
    desk.h,
    a.assigned_at,
    a.active as assignment_active
FROM employees e
JOIN departments d ON e.dept_id = d.id
LEFT JOIN assignments a ON e.id = a.employee_id AND a.active = true
LEFT JOIN desks desk ON a.desk_id = desk.id
WHERE e.active = true AND d.active = true;

COMMENT ON VIEW employee_desk_view IS '员工工位关联视图';
```

### 4.3 当前在线状态视图

```sql
CREATE VIEW current_presence_status AS
WITH latest_logs AS (
    SELECT 
        employee_id,
        status,
        desk_id,
        created_at,
        ROW_NUMBER() OVER (PARTITION BY employee_id ORDER BY created_at DESC) as rn
    FROM presence_logs
    WHERE created_at > NOW() - INTERVAL '1 hour'
)
SELECT 
    e.id as employee_id,
    e.name as employee_name,
    e.dept_id,
    d.name as dept_name,
    COALESCE(l.status, 'offline') as status,
    l.desk_id,
    l.created_at as last_seen
FROM employees e
JOIN departments d ON e.dept_id = d.id
LEFT JOIN latest_logs l ON e.id = l.employee_id AND l.rn = 1
WHERE e.active = true AND d.active = true;

COMMENT ON VIEW current_presence_status IS '当前员工在线状态视图';
```

## 5. 存储过程和函数

### 5.1 工位分配函数

```sql
CREATE OR REPLACE FUNCTION assign_desk(
    p_employee_id INTEGER,
    p_desk_id VARCHAR(100),
    p_assigned_by INTEGER DEFAULT NULL,
    p_notes TEXT DEFAULT NULL
) RETURNS INTEGER AS $$
DECLARE
    v_assignment_id INTEGER;
    v_existing_assignment INTEGER;
BEGIN
    -- 检查员工是否存在且活跃
    IF NOT EXISTS (SELECT 1 FROM employees WHERE id = p_employee_id AND active = true) THEN
        RAISE EXCEPTION '员工不存在或已禁用: %', p_employee_id;
    END IF;
    
    -- 检查工位是否存在且活跃
    IF NOT EXISTS (SELECT 1 FROM desks WHERE id = p_desk_id AND active = true) THEN
        RAISE EXCEPTION '工位不存在或已禁用: %', p_desk_id;
    END IF;
    
    -- 检查工位是否已被占用
    SELECT id INTO v_existing_assignment 
    FROM assignments 
    WHERE desk_id = p_desk_id AND active = true;
    
    IF v_existing_assignment IS NOT NULL THEN
        RAISE EXCEPTION '工位已被占用: %', p_desk_id;
    END IF;
    
    -- 取消员工当前的工位分配
    UPDATE assignments 
    SET active = false, unassigned_at = NOW()
    WHERE employee_id = p_employee_id AND active = true;
    
    -- 创建新的分配记录
    INSERT INTO assignments (employee_id, desk_id, assigned_by, notes)
    VALUES (p_employee_id, p_desk_id, p_assigned_by, p_notes)
    RETURNING id INTO v_assignment_id;
    
    RETURN v_assignment_id;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION assign_desk IS '分配工位给员工';
```

### 5.2 取消工位分配函数

```sql
CREATE OR REPLACE FUNCTION unassign_desk(
    p_employee_id INTEGER,
    p_unassigned_by INTEGER DEFAULT NULL
) RETURNS BOOLEAN AS $$
DECLARE
    v_updated_count INTEGER;
BEGIN
    -- 取消员工当前的工位分配
    UPDATE assignments 
    SET 
        active = false, 
        unassigned_at = NOW(),
        notes = COALESCE(notes, '') || 
                CASE WHEN p_unassigned_by IS NOT NULL 
                     THEN ' [取消分配操作人: ' || p_unassigned_by || ']'
                     ELSE ' [系统自动取消]'
                END
    WHERE employee_id = p_employee_id AND active = true;
    
    GET DIAGNOSTICS v_updated_count = ROW_COUNT;
    
    RETURN v_updated_count > 0;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION unassign_desk IS '取消员工工位分配';
```

### 5.3 更新在线状态函数

```sql
CREATE OR REPLACE FUNCTION update_presence_status(
    p_employee_id INTEGER,
    p_status presence_status,
    p_desk_id VARCHAR(100) DEFAULT NULL,
    p_session_id VARCHAR(128) DEFAULT NULL,
    p_ip_address INET DEFAULT NULL,
    p_metadata JSONB DEFAULT '{}'
) RETURNS VOID AS $$
BEGIN
    -- 插入状态日志
    INSERT INTO presence_logs (
        employee_id, status, desk_id, session_id, 
        ip_address, metadata
    ) VALUES (
        p_employee_id, p_status, p_desk_id, p_session_id,
        p_ip_address, p_metadata
    );
    
    -- 如果是离线状态，清理过期的会话
    IF p_status = 'offline' AND p_session_id IS NOT NULL THEN
        UPDATE user_sessions 
        SET expires_at = NOW()
        WHERE id = p_session_id;
    END IF;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION update_presence_status IS '更新员工在线状态';
```

## 6. 触发器定义

### 6.1 更新时间戳触发器

```sql
-- 通用更新时间戳函数
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 为相关表添加触发器
CREATE TRIGGER trigger_users_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_departments_updated_at
    BEFORE UPDATE ON departments
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trigger_employees_updated_at
    BEFORE UPDATE ON employees
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

### 6.2 数据验证触发器

```sql
-- 员工邮箱唯一性验证
CREATE OR REPLACE FUNCTION validate_employee_email()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.email IS NOT NULL THEN
        IF EXISTS (
            SELECT 1 FROM employees 
            WHERE email = NEW.email 
            AND id != COALESCE(NEW.id, -1)
            AND active = true
        ) THEN
            RAISE EXCEPTION '邮箱地址已存在: %', NEW.email;
        END IF;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_validate_employee_email
    BEFORE INSERT OR UPDATE ON employees
    FOR EACH ROW
    EXECUTE FUNCTION validate_employee_email();
```

## 7. 索引优化策略

### 7.1 查询性能索引

```sql
-- 复合索引：部门+活跃状态
CREATE INDEX idx_employees_dept_active ON employees(dept_id, active);
CREATE INDEX idx_desks_dept_active ON desks(dept_id, active);

-- 复合索引：员工+活跃分配
CREATE INDEX idx_assignments_employee_active ON assignments(employee_id, active);
CREATE INDEX idx_assignments_desk_active ON assignments(desk_id, active);

-- 时间范围查询索引
CREATE INDEX idx_presence_logs_employee_time ON presence_logs(employee_id, created_at DESC);
CREATE INDEX idx_user_sessions_user_expires ON user_sessions(user_id, expires_at);

-- 全文搜索索引
CREATE INDEX idx_employees_fulltext ON employees 
USING GIN(to_tsvector('simple', 
    name || ' ' || 
    COALESCE(title, '') || ' ' || 
    COALESCE(email, '') || ' ' ||
    COALESCE(employee_no, '')
));
```

### 7.2 部分索引优化

```sql
-- 仅为活跃记录创建索引
CREATE INDEX idx_employees_active_name ON employees(name) WHERE active = true;
CREATE INDEX idx_desks_active_label ON desks(label) WHERE active = true;
CREATE INDEX idx_assignments_active_only ON assignments(employee_id, desk_id) WHERE active = true;

-- 仅为有效会话创建索引
CREATE INDEX idx_user_sessions_valid ON user_sessions(user_id) WHERE expires_at > NOW();
```

## 8. 数据约束和规则

### 8.1 检查约束

```sql
-- 用户角色约束
ALTER TABLE users ADD CONSTRAINT chk_users_role 
    CHECK (role IN ('admin', 'user'));

-- 坐标约束
ALTER TABLE desks ADD CONSTRAINT chk_desks_coordinates 
    CHECK (x >= 0 AND y >= 0 AND w > 0 AND h > 0);

-- 邮箱格式约束
ALTER TABLE employees ADD CONSTRAINT chk_employees_email 
    CHECK (email IS NULL OR email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$');

-- 电话格式约束
ALTER TABLE employees ADD CONSTRAINT chk_employees_phone 
    CHECK (phone IS NULL OR phone ~* '^1[3-9]\d{9}$');
```

### 8.2 业务规则约束

```sql
-- 分配时间逻辑约束
ALTER TABLE assignments ADD CONSTRAINT chk_assignments_time 
    CHECK (unassigned_at IS NULL OR unassigned_at >= assigned_at);

-- 会话过期时间约束
ALTER TABLE user_sessions ADD CONSTRAINT chk_sessions_expires 
    CHECK (expires_at > created_at);

-- 地图文件大小约束（最大100MB）
ALTER TABLE maps ADD CONSTRAINT chk_maps_file_size 
    CHECK (file_size IS NULL OR file_size <= 104857600);
```

## 9. 数据初始化

### 9.1 基础数据插入

```sql
-- 插入默认管理员用户
INSERT INTO users (username, password_hash, name, email, role) VALUES 
('admin', '$2b$10$rQZ8ZqNQzqNQzqNQzqNQzO', '系统管理员', 'admin@company.com', 'admin'),
('demo', '$2b$10$rQZ8ZqNQzqNQzqNQzqNQzO', '演示用户', 'demo@company.com', 'user');

-- 插入示例部门
INSERT INTO departments (name, floor, description) VALUES 
('Engineering', '2F', '工程技术部'),
('Marketing', '3F', '市场营销部'),
('HR', '1F', '人力资源部'),
('Finance', '1F', '财务部');

-- 插入示例地图
INSERT INTO maps (id, type, url, dept_id) VALUES 
('eng_floor_2', 'svg', '/maps/engineering_floor2.svg', 1),
('mkt_floor_3', 'svg', '/maps/marketing_floor3.svg', 2),
('hr_floor_1', 'svg', '/maps/hr_floor1.svg', 3),
('fin_floor_1', 'svg', '/maps/finance_floor1.svg', 4);
```

### 9.2 示例工位数据

```sql
-- 为Engineering部门创建工位
DO $$
DECLARE
    i INTEGER;
BEGIN
    FOR i IN 1..20 LOOP
        INSERT INTO desks (id, label, dept_id, x, y, w, h) VALUES (
            'ENG-' || LPAD(i::TEXT, 3, '0'),
            'E' || LPAD(i::TEXT, 2, '0'),
            1,
            100 + ((i - 1) % 5) * 120,
            100 + ((i - 1) / 5) * 100,
            60,
            40
        );
    END LOOP;
END $$;

-- 为Marketing部门创建工位
DO $$
DECLARE
    i INTEGER;
BEGIN
    FOR i IN 1..15 LOOP
        INSERT INTO desks (id, label, dept_id, x, y, w, h) VALUES (
            'MKT-' || LPAD(i::TEXT, 3, '0'),
            'M' || LPAD(i::TEXT, 2, '0'),
            2,
            150 + ((i - 1) % 5) * 120,
            150 + ((i - 1) / 5) * 100,
            60,
            40
        );
    END LOOP;
END $$;
```

### 9.3 示例员工数据

```sql
-- 插入示例员工
INSERT INTO employees (name, dept_id, employee_no, title, email, phone) VALUES 
('张三', 1, 'EMP001', '前端工程师', 'zhangsan@company.com', '13800138001'),
('李四', 1, 'EMP002', '后端工程师', 'lisi@company.com', '13800138002'),
('王五', 1, 'EMP003', '全栈工程师', 'wangwu@company.com', '13800138003'),
('赵六', 1, 'EMP004', '测试工程师', 'zhaoliu@company.com', '13800138004'),
('钱七', 2, 'EMP005', '产品经理', 'qianqi@company.com', '13800138005'),
('孙八', 2, 'EMP006', '市场专员', 'sunba@company.com', '13800138006'),
('周九', 3, 'EMP007', 'HR专员', 'zhoujiu@company.com', '13800138007'),
('吴十', 4, 'EMP008', '财务专员', 'wushi@company.com', '13800138008');

-- 创建工位分配
SELECT assign_desk(1, 'ENG-001', 1, '初始分配');
SELECT assign_desk(2, 'ENG-002', 1, '初始分配');
SELECT assign_desk(3, 'ENG-003', 1, '初始分配');
SELECT assign_desk(4, 'ENG-004', 1, '初始分配');
SELECT assign_desk(5, 'MKT-001', 1, '初始分配');
SELECT assign_desk(6, 'MKT-002', 1, '初始分配');
```

## 10. 备份和恢复策略

### 10.1 备份策略

```bash
#!/bin/bash
# 每日全量备份脚本

BACKUP_DIR="/var/backups/postgresql"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="dept_map"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 全量备份
pg_dump -h localhost -U postgres -d $DB_NAME \
    --format=custom \
    --compress=9 \
    --file="$BACKUP_DIR/dept_map_$DATE.backup"

# 保留最近30天的备份
find $BACKUP_DIR -name "dept_map_*.backup" -mtime +30 -delete

# 备份到远程存储
aws s3 cp "$BACKUP_DIR/dept_map_$DATE.backup" \
    "s3://company-db-backups/dept_map/"
```

### 10.2 恢复脚本

```bash
#!/bin/bash
# 数据库恢复脚本

BACKUP_FILE=$1
DB_NAME="dept_map"

if [ -z "$BACKUP_FILE" ]; then
    echo "Usage: $0 <backup_file>"
    exit 1
fi

# 停止应用服务
sudo systemctl stop dept-map-api

# 删除现有数据库
dropdb -h localhost -U postgres $DB_NAME

# 创建新数据库
createdb -h localhost -U postgres $DB_NAME

# 恢复数据
pg_restore -h localhost -U postgres -d $DB_NAME \
    --clean --if-exists \
    $BACKUP_FILE

# 重启应用服务
sudo systemctl start dept-map-api

echo "Database restored successfully from $BACKUP_FILE"
```

## 11. 性能监控

### 11.1 性能监控查询

```sql
-- 慢查询监控
SELECT 
    query,
    calls,
    total_time,
    mean_time,
    rows
FROM pg_stat_statements 
WHERE mean_time > 100
ORDER BY mean_time DESC
LIMIT 10;

-- 表大小监控
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size,
    pg_total_relation_size(schemaname||'.'||tablename) as size_bytes
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY size_bytes DESC;

-- 索引使用情况
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE idx_scan = 0
ORDER BY schemaname, tablename;
```

### 11.2 连接监控

```sql
-- 当前连接状态
SELECT 
    state,
    COUNT(*) as connection_count
FROM pg_stat_activity 
WHERE datname = 'dept_map'
GROUP BY state;

-- 长时间运行的查询
SELECT 
    pid,
    now() - pg_stat_activity.query_start AS duration,
    query,
    state
FROM pg_stat_activity 
WHERE (now() - pg_stat_activity.query_start) > interval '5 minutes'
AND state != 'idle';
```

***

**数据库设计约束**：

* 数据库连接池最大20个连接

* 单表记录数不超过1000万条

* 索引数量控制在合理范围内

* 定期清理历史数据和日志

* 实施数据归档策略

* 监控数据库性能指标

* 定期优化查询和索引

