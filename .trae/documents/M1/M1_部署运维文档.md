# 部门地图 M1 阶段部署运维文档

***

**文档版本**: M1.1.0\
**创建日期**: 2024-09-7\
**最后更新**: 2024-09-7\
**更新内容**: 完善监控告警和故障处理流程
-----------------------

## 1. 部署架构概述

### 1.1 整体部署架构

```mermaid
graph TD
    A[负载均衡器 Nginx] --> B[API服务器 Node.js]
    B --> C[PostgreSQL 主库]
    B --> D[Redis 缓存]
    B --> E[文件存储]
    
    F[备份服务器] --> C
    G[监控服务 Prometheus] --> B
    G --> C
    G --> D
    H[日志收集 ELK] --> B
    
    subgraph "生产环境"
        A
        B
        C
        D
        E
    end
    
    subgraph "运维服务"
        F
        G
        H
    end
```

### 1.2 服务器配置要求

| 服务       | CPU | 内存   | 存储        | 网络    |
| -------- | --- | ---- | --------- | ----- |
| API服务器   | 4核  | 8GB  | 100GB SSD | 1Gbps |
| 数据库服务器   | 8核  | 16GB | 500GB SSD | 1Gbps |
| Redis服务器 | 2核  | 4GB  | 50GB SSD  | 1Gbps |
| 负载均衡器    | 2核  | 4GB  | 50GB SSD  | 1Gbps |

### 1.3 网络架构

```mermaid
graph LR
    A[Internet] --> B[防火墙]
    B --> C[负载均衡器]
    C --> D[DMZ区域]
    D --> E[内网区域]
    
    subgraph "DMZ区域"
        F[Web服务器]
        G[API网关]
    end
    
    subgraph "内网区域"
        H[应用服务器]
        I[数据库服务器]
        J[缓存服务器]
    end
    
    F --> H
    G --> H
    H --> I
    H --> J
```

## 2. 环境准备

### 2.1 操作系统配置

**推荐系统**: Ubuntu 22.04 LTS 或 CentOS 8

```bash
# 系统更新
sudo apt update && sudo apt upgrade -y

# 安装基础工具
sudo apt install -y curl wget git vim htop iotop net-tools

# 配置时区
sudo timedatectl set-timezone Asia/Shanghai

# 配置系统限制
echo "* soft nofile 65536" >> /etc/security/limits.conf
echo "* hard nofile 65536" >> /etc/security/limits.conf
echo "* soft nproc 32768" >> /etc/security/limits.conf
echo "* hard nproc 32768" >> /etc/security/limits.conf

# 优化内核参数
echo "net.core.somaxconn = 1024" >> /etc/sysctl.conf
echo "net.ipv4.tcp_max_syn_backlog = 1024" >> /etc/sysctl.conf
echo "vm.swappiness = 10" >> /etc/sysctl.conf
sudo sysctl -p
```

### 2.2 Docker环境安装

```bash
# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 启动Docker服务
sudo systemctl enable docker
sudo systemctl start docker

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker --version
docker-compose --version
```

### 2.3 Node.js环境安装

```bash
# 安装Node.js 18 LTS
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装PM2进程管理器
sudo npm install -g pm2

# 验证安装
node --version
npm --version
pm2 --version
```

## 3. 数据库部署

### 3.1 PostgreSQL安装配置

```bash
# 安装PostgreSQL 15
sudo apt install -y postgresql-15 postgresql-client-15 postgresql-contrib-15

# 启动服务
sudo systemctl enable postgresql
sudo systemctl start postgresql

# 创建数据库和用户
sudo -u postgres psql << EOF
CREATE DATABASE dept_map;
CREATE USER dept_map_user WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE dept_map TO dept_map_user;
ALTER USER dept_map_user CREATEDB;
\q
EOF
```

### 3.2 PostgreSQL配置优化

```bash
# 编辑配置文件
sudo vim /etc/postgresql/15/main/postgresql.conf
```

**关键配置项**:

```ini
# 连接配置
max_connections = 100
shared_buffers = 2GB
effective_cache_size = 6GB
work_mem = 64MB
maintenance_work_mem = 512MB

# WAL配置
wal_buffers = 16MB
checkpoint_completion_target = 0.9
max_wal_size = 2GB
min_wal_size = 1GB

# 日志配置
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on

# 性能监控
shared_preload_libraries = 'pg_stat_statements'
track_activity_query_size = 2048
pg_stat_statements.track = all
```

### 3.3 Redis安装配置

```bash
# 安装Redis
sudo apt install -y redis-server

# 配置Redis
sudo vim /etc/redis/redis.conf
```

**关键配置项**:

```ini
# 网络配置
bind 127.0.0.1
port 6379
timeout 300

# 内存配置
maxmemory 2gb
maxmemory-policy allkeys-lru

# 持久化配置
save 900 1
save 300 10
save 60 10000
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /var/lib/redis

# AOF配置
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec

# 安全配置
requirepass your_redis_password
```

```bash
# 重启Redis服务
sudo systemctl restart redis-server
sudo systemctl enable redis-server
```

## 4. 应用部署

### 4.1 项目结构

```
/opt/dept-map/
├── api/                    # API服务代码
│   ├── src/
│   ├── dist/
│   ├── package.json
│   ├── .env.production
│   └── ecosystem.config.js
├── web/                    # 前端代码
│   ├── dist/
│   └── nginx.conf
├── docker/                 # Docker配置
│   ├── docker-compose.yml
│   ├── Dockerfile.api
│   └── Dockerfile.web
├── scripts/                # 部署脚本
│   ├── deploy.sh
│   ├── backup.sh
│   └── health-check.sh
├── logs/                   # 日志目录
└── uploads/                # 文件上传目录
```

### 4.2 环境变量配置

**API服务环境变量** (`.env.production`):

```bash
# 应用配置
NODE_ENV=production
PORT=3000
API_VERSION=v1

# 数据库配置
DATABASE_URL=postgresql://dept_map_user:your_secure_password@localhost:5432/dept_map
DATABASE_POOL_MIN=5
DATABASE_POOL_MAX=20

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=your_redis_password
REDIS_DB=0

# JWT配置
JWT_SECRET=your_jwt_secret_key_here
JWT_EXPIRES_IN=3600
REFRESH_TOKEN_EXPIRES_IN=604800

# 文件上传配置
UPLOAD_DIR=/opt/dept-map/uploads
MAX_FILE_SIZE=10485760
ALLOWED_FILE_TYPES=svg,png,jpg,jpeg

# 日志配置
LOG_LEVEL=info
LOG_DIR=/opt/dept-map/logs

# 安全配置
CORS_ORIGIN=https://your-domain.com
RATE_LIMIT_WINDOW=900000
RATE_LIMIT_MAX=100

# 监控配置
HEALTH_CHECK_INTERVAL=30000
METRICS_ENABLED=true
```

### 4.3 PM2配置

**ecosystem.config.js**:

```javascript
module.exports = {
  apps: [{
    name: 'dept-map-api',
    script: './dist/app.js',
    cwd: '/opt/dept-map/api',
    instances: 2,
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    log_file: '/opt/dept-map/logs/app.log',
    error_file: '/opt/dept-map/logs/error.log',
    out_file: '/opt/dept-map/logs/out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
    max_memory_restart: '1G',
    node_args: '--max-old-space-size=1024',
    kill_timeout: 5000,
    wait_ready: true,
    listen_timeout: 10000,
    restart_delay: 1000,
    max_restarts: 10,
    min_uptime: '10s',
    watch: false,
    ignore_watch: ['node_modules', 'logs'],
    env_production: {
      NODE_ENV: 'production'
    }
  }]
};
```

### 4.4 Nginx配置

**/etc/nginx/sites-available/dept-map**:

```nginx
upstream api_backend {
    server 127.0.0.1:3000;
    keepalive 32;
}

server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    # SSL配置
    ssl_certificate /etc/ssl/certs/your-domain.crt;
    ssl_certificate_key /etc/ssl/private/your-domain.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    # 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains";
    
    # 日志配置
    access_log /var/log/nginx/dept-map.access.log;
    error_log /var/log/nginx/dept-map.error.log;
    
    # 前端静态文件
    location / {
        root /opt/dept-map/web/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
        
        # 缓存配置
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # API代理
    location /api/ {
        proxy_pass http://api_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 超时配置
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # 缓冲配置
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }
    
    # 文件上传
    location /uploads/ {
        alias /opt/dept-map/uploads/;
        expires 1d;
        add_header Cache-Control "public";
        
        # 安全配置
        location ~* \.(php|jsp|asp|sh|py)$ {
            deny all;
        }
    }
    
    # 健康检查
    location /health {
        proxy_pass http://api_backend/health;
        access_log off;
    }
    
    # 限制文件上传大小
    client_max_body_size 10M;
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
}
```

## 5. Docker部署方案

### 5.1 Docker Compose配置

**docker-compose.yml**:

```yaml
version: '3.9'

services:
  # API服务
  api:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
    container_name: dept-map-api
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://dept_map_user:${DB_PASSWORD}@db:5432/dept_map
      - REDIS_HOST=redis
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs
    depends_on:
      - db
      - redis
    networks:
      - dept-map-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
  
  # 数据库服务
  db:
    image: postgres:15-alpine
    container_name: dept-map-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=dept_map
      - POSTGRES_USER=dept_map_user
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - dept-map-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dept_map_user -d dept_map"]
      interval: 30s
      timeout: 10s
      retries: 3
  
  # Redis缓存
  redis:
    image: redis:7-alpine
    container_name: dept-map-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - dept-map-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
  
  # Nginx代理
  nginx:
    image: nginx:alpine
    container_name: dept-map-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./web/dist:/usr/share/nginx/html
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
      - ./uploads:/usr/share/nginx/html/uploads
    depends_on:
      - api
    networks:
      - dept-map-network

volumes:
  postgres_data:
  redis_data:

networks:
  dept-map-network:
    driver: bridge
```

### 5.2 API服务Dockerfile

**docker/Dockerfile.api**:

```dockerfile
FROM node:18-alpine AS builder

WORKDIR /app

# 复制依赖文件
COPY package*.json ./
COPY prisma ./prisma/

# 安装依赖
RUN npm ci --only=production && npm cache clean --force

# 生成Prisma客户端
RUN npx prisma generate

# 复制源代码
COPY src ./src
COPY tsconfig.json ./

# 构建应用
RUN npm run build

# 生产镜像
FROM node:18-alpine AS production

WORKDIR /app

# 安装运行时依赖
RUN apk add --no-cache curl

# 创建非root用户
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nodejs -u 1001

# 复制构建产物
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/prisma ./prisma
COPY package*.json ./

# 创建必要目录
RUN mkdir -p /app/uploads /app/logs
RUN chown -R nodejs:nodejs /app

USER nodejs

EXPOSE 3000

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/health || exit 1

CMD ["node", "dist/app.js"]
```

## 6. 部署脚本

### 6.1 自动化部署脚本

**scripts/deploy.sh**:

```bash
#!/bin/bash

set -e

# 配置变量
APP_NAME="dept-map"
APP_DIR="/opt/dept-map"
GIT_REPO="https://github.com/company/dept-map.git"
BRANCH="main"
BACKUP_DIR="/var/backups/dept-map"

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
}

warn() {
    echo -e "${YELLOW}[$(date +'%Y-%m-%d %H:%M:%S')] WARNING: $1${NC}"
}

error() {
    echo -e "${RED}[$(date +'%Y-%m-%d %H:%M:%S')] ERROR: $1${NC}"
    exit 1
}

# 检查权限
if [[ $EUID -ne 0 ]]; then
   error "This script must be run as root"
fi

# 创建备份
log "Creating backup..."
mkdir -p $BACKUP_DIR
DATE=$(date +%Y%m%d_%H%M%S)
if [ -d "$APP_DIR" ]; then
    tar -czf "$BACKUP_DIR/backup_$DATE.tar.gz" -C "$APP_DIR" .
fi

# 停止服务
log "Stopping services..."
sudo -u nodejs pm2 stop $APP_NAME || true
sudo systemctl stop nginx || true

# 更新代码
log "Updating code..."
if [ ! -d "$APP_DIR" ]; then
    mkdir -p $APP_DIR
    git clone $GIT_REPO $APP_DIR
else
    cd $APP_DIR
    git fetch origin
    git reset --hard origin/$BRANCH
fi

cd $APP_DIR

# 安装依赖
log "Installing dependencies..."
cd api
sudo -u nodejs npm ci --only=production

# 构建应用
log "Building application..."
sudo -u nodejs npm run build

# 数据库迁移
log "Running database migrations..."
sudo -u nodejs npx prisma migrate deploy
sudo -u nodejs npx prisma generate

# 构建前端
log "Building frontend..."
cd ../web
sudo -u nodejs npm ci
sudo -u nodejs npm run build

# 设置权限
log "Setting permissions..."
chown -R nodejs:nodejs $APP_DIR
chmod -R 755 $APP_DIR

# 启动服务
log "Starting services..."
sudo -u nodejs pm2 start $APP_DIR/api/ecosystem.config.js
sudo systemctl start nginx

# 健康检查
log "Performing health check..."
sleep 10
if curl -f http://localhost:3000/health > /dev/null 2>&1; then
    log "Deployment successful!"
else
    error "Health check failed. Rolling back..."
    # 回滚逻辑
    sudo -u nodejs pm2 stop $APP_NAME
    cd $APP_DIR
    tar -xzf "$BACKUP_DIR/backup_$DATE.tar.gz" .
    sudo -u nodejs pm2 start $APP_NAME
fi

# 清理旧备份
find $BACKUP_DIR -name "backup_*.tar.gz" -mtime +7 -delete

log "Deployment completed successfully!"
```

### 6.2 数据库备份脚本

**scripts/backup.sh**:

```bash
#!/bin/bash

set -e

# 配置
DB_NAME="dept_map"
DB_USER="dept_map_user"
BACKUP_DIR="/var/backups/postgresql"
S3_BUCKET="company-db-backups"
RETENTION_DAYS=30

# 创建备份目录
mkdir -p $BACKUP_DIR

# 生成备份文件名
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/${DB_NAME}_$DATE.sql"
COMPRESSED_FILE="$BACKUP_FILE.gz"

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"
}

log "Starting database backup..."

# 执行备份
pg_dump -h localhost -U $DB_USER -d $DB_NAME \
    --no-password \
    --verbose \
    --format=plain \
    --no-owner \
    --no-privileges \
    > $BACKUP_FILE

# 压缩备份文件
gzip $BACKUP_FILE

# 验证备份文件
if [ -f "$COMPRESSED_FILE" ] && [ -s "$COMPRESSED_FILE" ]; then
    log "Backup created successfully: $COMPRESSED_FILE"
else
    log "ERROR: Backup failed or file is empty"
    exit 1
fi

# 上传到S3（如果配置了）
if command -v aws &> /dev/null && [ -n "$S3_BUCKET" ]; then
    log "Uploading backup to S3..."
    aws s3 cp "$COMPRESSED_FILE" "s3://$S3_BUCKET/postgresql/"
    log "Backup uploaded to S3"
fi

# 清理旧备份
log "Cleaning up old backups..."
find $BACKUP_DIR -name "${DB_NAME}_*.sql.gz" -mtime +$RETENTION_DAYS -delete

log "Backup completed successfully"
```

### 6.3 健康检查脚本

**scripts/health-check.sh**:

```bash
#!/bin/bash

# 配置
API_URL="http://localhost:3000"
DB_HOST="localhost"
DB_NAME="dept_map"
DB_USER="dept_map_user"
REDIS_HOST="localhost"
REDIS_PORT="6379"

# 检查结果
ERRORS=0

check_service() {
    local service_name=$1
    local check_command=$2
    
    echo -n "Checking $service_name... "
    if eval $check_command > /dev/null 2>&1; then
        echo "✓ OK"
    else
        echo "✗ FAILED"
        ((ERRORS++))
    fi
}

echo "=== Health Check Report ==="
echo "Timestamp: $(date)"
echo

# 检查API服务
check_service "API Service" "curl -f $API_URL/health"

# 检查数据库
check_service "PostgreSQL" "pg_isready -h $DB_HOST -d $DB_NAME -U $DB_USER"

# 检查Redis
check_service "Redis" "redis-cli -h $REDIS_HOST -p $REDIS_PORT ping"

# 检查Nginx
check_service "Nginx" "systemctl is-active nginx"

# 检查PM2进程
check_service "PM2 Process" "pm2 describe dept-map-api | grep -q 'online'"

# 检查磁盘空间
DISK_USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
echo -n "Checking disk usage... "
if [ $DISK_USAGE -lt 80 ]; then
    echo "✓ OK ($DISK_USAGE%)"
else
    echo "✗ WARNING: High disk usage ($DISK_USAGE%)"
    ((ERRORS++))
fi

# 检查内存使用
MEM_USAGE=$(free | awk 'NR==2{printf "%.0f", $3*100/$2}')
echo -n "Checking memory usage... "
if [ $MEM_USAGE -lt 90 ]; then
    echo "✓ OK ($MEM_USAGE%)"
else
    echo "✗ WARNING: High memory usage ($MEM_USAGE%)"
    ((ERRORS++))
fi

echo
if [ $ERRORS -eq 0 ]; then
    echo "✓ All checks passed"
    exit 0
else
    echo "✗ $ERRORS check(s) failed"
    exit 1
fi
```

## 7. 监控和日志

### 7.1 Prometheus监控配置

**prometheus.yml**:

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "alert_rules.yml"

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

scrape_configs:
  - job_name: 'dept-map-api'
    static_configs:
      - targets: ['localhost:3000']
    metrics_path: '/metrics'
    scrape_interval: 30s
  
  - job_name: 'postgres'
    static_configs:
      - targets: ['localhost:9187']
  
  - job_name: 'redis'
    static_configs:
      - targets: ['localhost:9121']
  
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['localhost:9100']
```

### 7.2 告警规则配置

**alert\_rules.yml**:

```yaml
groups:
  - name: dept-map-alerts
    rules:
      # API服务告警
      - alert: APIServiceDown
        expr: up{job="dept-map-api"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "API service is down"
          description: "API service has been down for more than 1 minute"
      
      # 响应时间告警
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High API response time"
          description: "95th percentile response time is above 500ms"
      
      # 数据库连接告警
      - alert: DatabaseConnectionHigh
        expr: pg_stat_activity_count > 80
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High database connections"
          description: "Database connection count is above 80"
      
      # 内存使用告警
      - alert: HighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes > 0.9
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High memory usage"
          description: "Memory usage is above 90%"
      
      # 磁盘空间告警
      - alert: DiskSpaceLow
        expr: (node_filesystem_size_bytes - node_filesystem_free_bytes) / node_filesystem_size_bytes > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Low disk space"
          description: "Disk usage is above 80%"
```

### 7.3 日志配置

**Logrotate配置** (`/etc/logrotate.d/dept-map`):

```
/opt/dept-map/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 nodejs nodejs
    postrotate
        pm2 reloadLogs
    endscript
}

/var/log/nginx/dept-map.*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 www-data www-data
    postrotate
        systemctl reload nginx
    endscript
}
```

## 8. 安全配置

### 8.1 防火墙配置

```bash
# 安装UFW
sudo apt install -y ufw

# 默认策略
sudo ufw default deny incoming
sudo ufw default allow outgoing

# 允许SSH
sudo ufw allow ssh

# 允许HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 允许内网访问数据库（根据实际网段调整）
sudo ufw allow from 10.0.0.0/8 to any port 5432
sudo ufw allow from 10.0.0.0/8 to any port 6379

# 启用防火墙
sudo ufw enable

# 查看状态
sudo ufw status verbose
```

### 8.2 SSL证书配置

```bash
# 安装Certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d your-domain.com

# 设置自动续期
echo "0 12 * * * /usr/bin/certbot renew --quiet" | sudo crontab -
```

### 8.3 系统安全加固

```bash
# 禁用root SSH登录
sudo sed -i 's/#PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
sudo systemctl restart ssh

# 安装fail2ban
sudo apt install -y fail2ban

# 配置fail2ban
sudo tee /etc/fail2ban/jail.local << EOF
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 3

[sshd]
enabled = true

[nginx-http-auth]
enabled = true

[nginx-limit-req]
enabled = true
EOF

sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

## 9. 故障处理

### 9.1 常见问题诊断

**API服务无响应**:

```bash
# 检查进程状态
pm2 status
pm2 logs dept-map-api

# 检查端口占用
sudo netstat -tlnp | grep :3000

# 检查系统资源
top
free -h
df -h

# 重启服务
pm2 restart dept-map-api
```

**数据库连接问题**:

```bash
# 检查数据库状态
sudo systemctl status postgresql

# 检查连接数
sudo -u postgres psql -c "SELECT count(*) FROM pg_stat_activity;"

# 检查慢查询
sudo -u postgres psql -d dept_map -c "SELECT query, mean_time FROM pg_stat_statements ORDER BY mean_time DESC LIMIT 10;"

# 重启数据库
sudo systemctl restart postgresql
```

**Redis缓存问题**:

```bash
# 检查Redis状态
sudo systemctl status redis-server

# 检查内存使用
redis-cli info memory

# 清理缓存
redis-cli flushall

# 重启Redis
sudo systemctl restart redis-server
```

### 9.2 应急响应流程

1. **服务中断响应**:

   * 立即检查服务状态

   * 查看错误日志

   * 尝试重启服务

   * 如无法恢复，启动备用方案

2. **数据库故障响应**:

   * 检查数据库连接

   * 查看数据库日志

   * 检查磁盘空间

   * 必要时从备份恢复

3. **性能问题响应**:

   * 检查系统资源使用

   * 分析慢查询日志

   * 检查缓存命中率

   * 临时扩容或优化

## 10. 维护计划

### 10.1 日常维护任务

**每日任务**:

* 检查服务状态

* 查看错误日志

* 监控系统资源

* 验证备份完成

**每周任务**:

* 更新系统补丁

* 清理日志文件

* 检查磁盘空间

* 性能报告分析

**每月任务**:

* 数据库维护

* 安全扫描

* 备份恢复测试

* 容量规划评估

### 10.2 维护脚本

**每日维护脚本** (`scripts/daily-maintenance.sh`):

```bash
#!/bin/bash

# 健康检查
./health-check.sh

# 清理临时文件
find /tmp -name "*.tmp" -mtime +1 -delete

# 清理应用日志
find /opt/dept-map/logs -name "*.log" -size +100M -exec truncate -s 50M {} \;

# 数据库统计信息更新
sudo -u postgres psql -d dept_map -c "ANALYZE;"

# Redis内存优化
redis-cli MEMORY PURGE

# 生成日报
echo "Daily maintenance completed at $(date)" >> /var/log/maintenance.log
```

***

**部署运维约束**：

* 生产环境必须使用HTTPS

* 数据库必须启用备份和监控

* 所有服务必须配置健康检查

* 日志保留期不少于30天

* 系统资源使用率不超过80%

* 必须配置告警和通知机制

* 定期进行安全扫描和更新

