# 端口职责分离规范

## 1. 端口分配总览

| 端口 | 服务类型 | 主要功能 | 配置文件 | 启动命令 |
|------|----------|----------|----------|----------|
| 5173 | 前端主应用 | React地图系统 | vite.config.ts | `npm run client:dev` |
| 3000 | 服务器管理 | 静态HTML管理界面 | vite.server-management.config.ts | `npm run server-management:dev` |
| 3001 | 调试端口 | 开发调试工具 | - | 预留 |
| 8080 | 后端API | Express服务器 | api/server.js | `npm run server:dev` |

## 2. 端口详细规范

### 2.1 端口 5173 - 前端主应用

**职责**: React地图系统主应用

**技术栈**:
- React 19.1.1
- TypeScript
- Vite
- Tailwind CSS

**路由结构**:
```
http://localhost:5173/
├── /                    # 主页面
├── /login              # 登录页面
├── /dashboard          # 仪表板
├── /map                # 地图界面
├── /settings           # 设置页面
└── /profile            # 用户资料
```

**配置文件**: `vite.config.ts`
**入口文件**: `index.html` → `src/main.tsx`
**启动命令**: `npm run client:dev`

### 2.2 端口 3000 - 服务器管理界面

**职责**: M1服务器管理系统（静态HTML版本）

**技术栈**:
- 静态HTML
- 原生CSS
- 原生JavaScript
- Vite（开发服务器）

**路由结构**:
```
http://localhost:3000/
├── /                           # 服务器管理主页
├── /index.html                 # 同主页
├── /server-management.html     # 同主页
├── /server-management          # 同主页（别名）
├── /legacy                     # 旧版管理界面
├── /server-management-legacy   # 旧版管理界面（别名）
└── /server-management-main     # 404 - 已废弃
```

**文件映射**:
- `/` → `server-management.html` (主版本)
- `/legacy` → `server-management-legacy.html` (旧版本)
- `/server-management-main` → 404页面

**配置文件**: `vite.server-management.config.ts`
**启动命令**: `npm run server-management:dev`

### 2.3 端口 3001 - 调试端口

**职责**: 开发调试和测试工具

**当前状态**: 预留端口
**用途**:
- 开发环境调试
- 性能测试
- API测试工具
- 未来功能扩展

### 2.4 端口 8080 - 后端API服务

**职责**: Express后端API服务

**技术栈**:
- Node.js
- Express.js
- PostgreSQL
- Redis
- JWT认证

**API路由结构**:
```
http://localhost:8080/
├── /api/auth/          # 认证相关API
├── /api/users/         # 用户管理API
├── /api/departments/   # 部门管理API
├── /api/maps/          # 地图数据API
├── /api/files/         # 文件上传API
└── /api/system/        # 系统管理API
```

**配置文件**: `api/server.js`
**启动命令**: `npm run server:dev`

## 3. 跨端口通信规范

### 3.1 前端主应用 (5173) ↔ 后端API (8080)

**通信方式**: HTTP/HTTPS + WebSocket
**代理配置**: 
```javascript
// vite.config.ts
server: {
  proxy: {
    '/api': {
      target: 'http://localhost:8080',
      changeOrigin: true
    }
  }
}
```

### 3.2 服务器管理 (3000) ↔ 后端API (8080)

**通信方式**: HTTP/HTTPS
**代理配置**:
```javascript
// vite.server-management.config.ts
server: {
  proxy: {
    '/api': {
      target: 'http://localhost:8080',
      changeOrigin: true
    }
  }
}
```

### 3.3 跨域处理

**CORS配置** (在后端API中):
```javascript
// api/server.js
app.use(cors({
  origin: [
    'http://localhost:5173',  // 前端主应用
    'http://localhost:3000',  // 服务器管理
    'http://localhost:3001'   // 调试端口
  ],
  credentials: true
}));
```

## 4. 开发环境启动规范

### 4.1 完整开发环境

```bash
# 启动所有服务
npm run dev:all

# 等价于
concurrently \
  "npm run client:dev" \
  "npm run server-management:dev" \
  "npm run server:dev"
```

### 4.2 分别启动

```bash
# 启动前端主应用 (5173)
npm run client:dev

# 启动服务器管理 (3000)
npm run server-management:dev

# 启动后端API (8080)
npm run server:dev

# 启动Redis (6379)
.\Redis\redis-server.exe .\Redis\redis.windows.conf
```

### 4.3 启动顺序建议

1. **Redis服务** (6379) - 数据缓存
2. **后端API** (8080) - 核心服务
3. **前端应用** (5173/3000) - 用户界面

## 5. 生产环境部署规范

### 5.1 端口映射

| 开发端口 | 生产端口 | 域名映射 |
|----------|----------|----------|
| 5173 | 80/443 | www.example.com |
| 3000 | 3000 | admin.example.com |
| 8080 | 8080 | api.example.com |

### 5.2 反向代理配置 (Nginx)

```nginx
# 前端主应用
server {
    listen 80;
    server_name www.example.com;
    location / {
        proxy_pass http://localhost:5173;
    }
}

# 服务器管理
server {
    listen 3000;
    server_name admin.example.com;
    location / {
        proxy_pass http://localhost:3000;
    }
}

# 后端API
server {
    listen 8080;
    server_name api.example.com;
    location / {
        proxy_pass http://localhost:8080;
    }
}
```

## 6. 安全规范

### 6.1 端口访问控制

- **5173**: 公开访问（生产环境需要认证）
- **3000**: 管理员访问（需要管理员权限）
- **3001**: 开发访问（仅开发环境）
- **8080**: API访问（需要API密钥或JWT）

### 6.2 防火墙规则

```bash
# 生产环境防火墙配置
# 允许HTTP/HTTPS
allow 80/tcp
allow 443/tcp

# 允许管理端口（限制IP）
allow 3000/tcp from 192.168.1.0/24

# 允许API端口
allow 8080/tcp

# 拒绝调试端口
deny 3001/tcp
```

## 7. 监控和日志

### 7.1 端口健康检查

```bash
# 检查端口状态
netstat -an | findstr :5173
netstat -an | findstr :3000
netstat -an | findstr :8080

# 或使用PowerShell
Get-NetTCPConnection -LocalPort 5173,3000,8080
```

### 7.2 日志文件位置

```
logs/
├── client-5173.log          # 前端主应用日志
├── server-management-3000.log # 服务器管理日志
├── api-8080.log             # 后端API日志
└── system.log               # 系统级日志
```

## 8. 故障排除

### 8.1 端口冲突处理

```bash
# 查找占用端口的进程
netstat -ano | findstr :3000

# 终止进程
taskkill /PID <进程ID> /F

# 或使用PowerShell
Get-Process -Id (Get-NetTCPConnection -LocalPort 3000).OwningProcess | Stop-Process
```

### 8.2 常见问题

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 端口被占用 | 其他进程使用端口 | 终止进程或更换端口 |
| 跨域错误 | CORS配置错误 | 检查后端CORS设置 |
| 代理失败 | 代理配置错误 | 检查vite配置文件 |
| 404错误 | 路由配置错误 | 检查路由映射 |

## 9. 版本控制

### 9.1 配置文件版本管理

```
配置文件优先级:
1. 本地开发配置 (.env.local)
2. 环境特定配置 (.env.development)
3. 全局配置 (.env)
4. 默认配置 (代码中的默认值)
```

### 9.2 端口配置变更流程

1. **提交变更请求** - 说明变更原因
2. **更新配置文件** - 修改相关配置
3. **更新文档** - 同步更新本文档
4. **测试验证** - 确保所有端口正常工作
5. **部署上线** - 按照部署流程执行

## 10. 总结

通过明确的端口职责分离，项目实现了：

- ✅ **清晰的服务边界** - 每个端口有明确的职责
- ✅ **独立的开发环境** - 各服务可独立开发和测试
- ✅ **灵活的部署策略** - 支持分布式部署
- ✅ **完善的监控体系** - 便于问题定位和性能优化
- ✅ **标准化的开发流程** - 提高开发效率和代码质量

这种架构为项目的可扩展性、可维护性和可靠性奠定了坚实的基