# 开发规范文档

## 📋 概述

本文档制定了部门地图项目的开发规范和最佳实践，旨在确保代码质量、系统稳定性和团队协作效率。所有开发人员必须严格遵循这些规范。

## 🏗️ 架构设计规范

### 微前端架构原则

#### 1. 端口职责单一原则

**规范要求：**
- 每个端口只负责特定的功能模块
- 严禁功能重叠和内容重复
- 保持清晰的职责边界

**端口分工：**
```typescript
// 端口职责定义
const PORT_RESPONSIBILITIES = {
  5173: {
    name: '部门地图系统',
    responsibilities: ['地图展示', '人员搜索', '工位管理'],
    forbidden: ['服务器管理', '系统配置', 'API监控']
  },
  3000: {
    name: '服务器管理系统', 
    responsibilities: ['服务器监控', '系统管理', '用户权限'],
    forbidden: ['地图功能', '工位操作']
  },
  8080: {
    name: '后端API服务',
    responsibilities: ['数据接口', '业务逻辑', 'API监控'],
    forbidden: ['前端页面', '用户界面']
  }
};
```

#### 2. 访问控制强制规范

**必须实施的访问控制：**

```typescript
// vite.config.ts - 5173端口访问控制模板
const accessControlMiddleware = (req: any, res: any, next: any) => {
  // 禁止访问服务器管理页面
  const forbiddenPaths = [
    '/server-management.html',
    '/admin',
    '/management'
  ];
  
  if (forbiddenPaths.some(path => req.url.includes(path))) {
    res.status(403).json({
      error: 'Access Denied',
      message: `此端口不允许访问 ${req.url}，请使用正确的端口`,
      correctPort: getCorrectPort(req.url)
    });
    return;
  }
  next();
};

// 获取正确端口的辅助函数
function getCorrectPort(url: string): number {
  if (url.includes('server-management') || url.includes('admin')) {
    return 3000;
  }
  if (url.includes('api')) {
    return 8080;
  }
  return 5173;
}
```

#### 3. 配置文件隔离规范

**配置文件命名规范：**
- `vite.config.ts` - 部门地图系统配置
- `vite.server-management.config.ts` - 服务器管理系统配置
- `api.config.ts` - API服务配置

**配置隔离要求：**
```typescript
// 配置文件必须包含的字段
interface ViteConfig {
  server: {
    port: number;           // 明确端口号
    open: string | boolean; // 指定打开页面
    proxy: ProxyOptions;    // 代理配置
  };
  plugins: Plugin[];        // 插件配置
  build: {
    outDir: string;         // 独立输出目录
    rollupOptions: {
      input: string;        // 独立入口文件
    };
  };
}
```

## 🔒 安全开发规范

### 访问控制实施

#### 1. 中间件安全检查

**强制要求：**
- 所有端口必须实施访问控制中间件
- 禁止跨端口页面访问
- 实施最小权限原则

**安全检查清单：**
```typescript
// 安全检查函数模板
function securityCheck(config: ViteConfig): SecurityCheckResult {
  const checks = {
    hasAccessControl: checkAccessControlMiddleware(config),
    hasProperRouting: checkRoutingConfiguration(config),
    hasPortIsolation: checkPortIsolation(config),
    hasErrorHandling: checkErrorHandling(config)
  };
  
  return {
    passed: Object.values(checks).every(Boolean),
    details: checks
  };
}
```

#### 2. 错误处理规范

**统一错误响应格式：**
```typescript
interface ErrorResponse {
  error: string;
  message: string;
  code: number;
  timestamp: string;
  path: string;
  suggestion?: string;
}

// 错误处理中间件模板
const errorHandler = (error: any, req: any, res: any, next: any) => {
  const errorResponse: ErrorResponse = {
    error: error.name || 'UnknownError',
    message: error.message || '未知错误',
    code: error.status || 500,
    timestamp: new Date().toISOString(),
    path: req.url,
    suggestion: getSuggestion(error, req.url)
  };
  
  // 记录错误日志
  console.error(`[${errorResponse.timestamp}] ${errorResponse.error}: ${errorResponse.message}`);
  
  res.status(errorResponse.code).json(errorResponse);
};
```

### 数据安全规范

#### 1. 敏感信息保护

```typescript
// 环境变量管理
const REQUIRED_ENV_VARS = [
  'DATABASE_URL',
  'REDIS_URL', 
  'JWT_SECRET',
  'API_KEY'
];

// 启动时检查环境变量
function validateEnvironment(): void {
  const missing = REQUIRED_ENV_VARS.filter(key => !process.env[key]);
  if (missing.length > 0) {
    throw new Error(`缺少必要的环境变量: ${missing.join(', ')}`);
  }
}
```

#### 2. API安全规范

```typescript
// API安全中间件
const apiSecurityMiddleware = {
  rateLimit: rateLimit({
    windowMs: 15 * 60 * 1000, // 15分钟
    max: 100, // 限制每个IP 100次请求
    message: 'API调用频率过高，请稍后再试'
  }),
  
  authentication: (req: any, res: any, next: any) => {
    const token = req.headers.authorization?.replace('Bearer ', '');
    if (!token) {
      return res.status(401).json({ error: '缺少认证令牌' });
    }
    // JWT验证逻辑
    next();
  },
  
  validation: (schema: any) => (req: any, res: any, next: any) => {
    const { error } = schema.validate(req.body);
    if (error) {
      return res.status(400).json({ error: error.details[0].message });
    }
    next();
  }
};
```

## 📝 代码规范

### TypeScript规范

#### 1. 类型定义规范

```typescript
// 接口定义规范
interface ComponentProps {
  // 必需属性
  id: string;
  title: string;
  
  // 可选属性
  description?: string;
  className?: string;
  
  // 函数属性
  onClick?: (event: MouseEvent) => void;
  onSubmit?: (data: FormData) => Promise<void>;
}

// 枚举定义规范
enum SystemStatus {
  ONLINE = 'online',
  OFFLINE = 'offline',
  MAINTENANCE = 'maintenance'
}

// 联合类型规范
type Theme = 'light' | 'dark' | 'auto';
type Size = 'small' | 'medium' | 'large';
```

#### 2. 组件开发规范

```typescript
// React组件模板
import React, { useState, useEffect, useCallback } from 'react';
import { ComponentProps } from './types';
import './Component.css';

/**
 * 组件功能描述
 * @param props - 组件属性
 * @returns JSX元素
 */
const Component: React.FC<ComponentProps> = ({
  id,
  title,
  description,
  className = '',
  onClick,
  onSubmit
}) => {
  // 状态定义
  const [loading, setLoading] = useState<boolean>(false);
  const [error, setError] = useState<string | null>(null);
  
  // 副作用处理
  useEffect(() => {
    // 组件挂载逻辑
    return () => {
      // 清理逻辑
    };
  }, []);
  
  // 事件处理函数
  const handleClick = useCallback((event: MouseEvent) => {
    event.preventDefault();
    onClick?.(event);
  }, [onClick]);
  
  // 渲染逻辑
  return (
    <div className={`component ${className}`} id={id}>
      <h2>{title}</h2>
      {description && <p>{description}</p>}
      {error && <div className="error">{error}</div>}
    </div>
  );
};

export default Component;
```

### 文件组织规范

#### 1. 目录结构规范

```
src/
├── components/           # 共享组件
│   ├── common/          # 通用组件
│   ├── forms/           # 表单组件
│   └── layout/          # 布局组件
├── pages/               # 页面组件
│   ├── DepartmentMap/   # 部门地图页面
│   └── ServerManagement/ # 服务器管理页面
├── hooks/               # 自定义Hook
├── contexts/            # React上下文
├── services/            # API服务
├── utils/               # 工具函数
├── types/               # 类型定义
├── constants/           # 常量定义
└── styles/              # 样式文件
```

#### 2. 文件命名规范

- **组件文件**：PascalCase（如：`DepartmentMap.tsx`）
- **工具文件**：camelCase（如：`apiUtils.ts`）
- **常量文件**：UPPER_SNAKE_CASE（如：`API_ENDPOINTS.ts`）
- **样式文件**：kebab-case（如：`department-map.css`）

## 🧪 测试规范

### 单元测试规范

```typescript
// 测试文件模板
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { describe, it, expect, jest, beforeEach, afterEach } from '@jest/globals';
import Component from './Component';

describe('Component', () => {
  // 测试前准备
  beforeEach(() => {
    jest.clearAllMocks();
  });
  
  // 测试后清理
  afterEach(() => {
    jest.restoreAllMocks();
  });
  
  // 基础渲染测试
  it('should render correctly', () => {
    render(<Component id="test" title="Test Title" />);
    expect(screen.getByText('Test Title')).toBeInTheDocument();
  });
  
  // 交互测试
  it('should handle click events', async () => {
    const mockClick = jest.fn();
    render(<Component id="test" title="Test" onClick={mockClick} />);
    
    fireEvent.click(screen.getByText('Test'));
    await waitFor(() => {
      expect(mockClick).toHaveBeenCalledTimes(1);
    });
  });
  
  // 错误处理测试
  it('should handle errors gracefully', async () => {
    // 错误场景测试
  });
});
```

### 集成测试规范

```typescript
// 端口访问测试
describe('Port Access Control', () => {
  it('should deny access to server-management.html on port 5173', async () => {
    const response = await fetch('http://localhost:5173/server-management.html');
    expect(response.status).toBe(403);
    
    const data = await response.json();
    expect(data.error).toBe('Access Denied');
    expect(data.correctPort).toBe(3000);
  });
  
  it('should allow access to server-management.html on port 3000', async () => {
    const response = await fetch('http://localhost:3000/server-management.html');
    expect(response.status).toBe(200);
  });
});
```

## 🔄 Git工作流规范

### 分支管理规范

```bash
# 分支命名规范
feature/功能名称     # 新功能开发
fix/问题描述        # 问题修复
hotfix/紧急修复     # 紧急修复
refactor/重构描述   # 代码重构
docs/文档更新       # 文档更新

# 示例
feature/port-access-control
fix/duplicate-content-issue
hotfix/security-vulnerability
refactor/component-structure
docs/api-documentation
```

### 提交信息规范

```bash
# 提交格式
<type>(<scope>): <subject>

<body>

<footer>

# 类型说明
feat:     新功能
fix:      修复
docs:     文档
style:    格式
refactor: 重构
test:     测试
chore:    构建

# 示例
feat(access-control): 添加端口访问控制中间件

- 在vite.config.ts中添加访问控制中间件
- 禁止5173端口访问server-management.html
- 添加错误提示和正确端口引导

Closes #123
```

## 📊 性能规范

### 前端性能规范

```typescript
// 性能监控
const performanceMonitor = {
  // 页面加载时间监控
  measurePageLoad: () => {
    window.addEventListener('load', () => {
      const loadTime = performance.now();
      console.log(`页面加载时间: ${loadTime}ms`);
      
      // 发送性能数据到监控系统
      if (loadTime > 3000) {
        console.warn('页面加载时间过长，需要优化');
      }
    });
  },
  
  // 组件渲染时间监控
  measureComponentRender: (componentName: string) => {
    const startTime = performance.now();
    return () => {
      const endTime = performance.now();
      const renderTime = endTime - startTime;
      console.log(`${componentName} 渲染时间: ${renderTime}ms`);
    };
  }
};
```

### 后端性能规范

```typescript
// API性能监控
const apiPerformanceMiddleware = (req: any, res: any, next: any) => {
  const startTime = Date.now();
  
  res.on('finish', () => {
    const duration = Date.now() - startTime;
    console.log(`${req.method} ${req.url} - ${res.statusCode} - ${duration}ms`);
    
    // 性能告警
    if (duration > 1000) {
      console.warn(`API响应时间过长: ${req.url} - ${duration}ms`);
    }
  });
  
  next();
};
```

## 🚨 问题预防机制

### 代码审查检查清单

#### 架构层面检查
- [ ] 端口职责是否明确
- [ ] 是否存在功能重叠
- [ ] 访问控制是否正确实施
- [ ] 配置文件是否正确隔离

#### 安全层面检查
- [ ] 敏感信息是否正确保护
- [ ] API是否有适当的认证
- [ ] 错误处理是否完善
- [ ] 日志记录是否充分

#### 代码质量检查
- [ ] TypeScript类型是否完整
- [ ] 组件是否遵循规范
- [ ] 测试覆盖率是否足够
- [ ] 性能是否符合要求

#### 功能完整性检查 ⚠️
- [ ] 所有相关功能模块是否正常工作
- [ ] 数据映射和转换逻辑是否正确
- [ ] 搜索、跳转、定位等关联功能链路是否完整
- [ ] 部门中英文对照表是否完整
- [ ] 部门相关功能是否支持中英文双向查询
- [ ] 功能状态跟踪文档是否及时更新

### 自动化检查工具

```json
// package.json scripts
{
  "scripts": {
    "lint": "eslint src --ext .ts,.tsx",
    "type-check": "tsc --noEmit",
    "test": "jest",
    "test:coverage": "jest --coverage",
    "security-check": "npm audit",
    "port-check": "node scripts/check-ports.js",
    "pre-commit": "npm run lint && npm run type-check && npm run test"
  }
}
```

### 持续集成检查

```yaml
# .github/workflows/ci.yml
name: CI
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Lint check
        run: npm run lint
      
      - name: Type check
        run: npm run type-check
      
      - name: Run tests
        run: npm run test:coverage
      
      - name: Port access control check
        run: npm run port-check
      
      - name: Security audit
        run: npm run security-check
```

## 📚 学习资源

### 必读文档
- [系统架构关联逻辑文档](./系统架构关联逻辑文档.md)
- [端口配置文档](./端口配置文档.md)
- [API接口文档](./M1/M1_API接口文档.md)

### 推荐学习
- TypeScript官方文档
- React最佳实践
- Vite配置指南
- 微前端架构设计

## 📞 支持和反馈

如果对开发规范有疑问或建议，请：

1. 查阅相关文档
2. 在团队讨论区提问
3. 创建改进提案
4. 参与规范评审会议

---

**文档维护**：开发团队  
**最后更新**：2024年1月  
**审查周期**：每季度一次