# 部门地图系统 v2.0 技术规范文档

## 版本信息
- **版本号**: v2.0
- **创建日期**: 2024-01-15
- **最后更新**: 2024-01-15
- **文档状态**: 进行中

## 修改背景

### 当前系统问题
1. **搜索功能异常**: 系统仅能检索到技术部人员，其他部门人员（如人事部）在前端子地图可见但无法通过搜索功能查询
2. **数据同步问题**: 仅技术部数据建立了有效索引，缺乏全部门数据索引
3. **前端数据源不规范**: 使用虚拟文件作为数据源，未与数据库保持严格同步
4. **工位管理功能不完善**: M1服务器工位管理缺少完整的员工信息展示和部门筛选功能

### 业务影响
- 用户无法有效搜索非技术部门员工
- 数据一致性问题导致前端展示与实际数据不符
- 管理员无法进行有效的跨部门工位管理

## 修改目的

### 主要目标
1. **建立完整的数据索引系统**: 确保所有部门人员数据可被检索
2. **实现前端与数据库实时同步**: 建立基于SQL查询的缓存机制
3. **完善搜索功能**: 实现全部门跨域搜索
4. **增强工位管理**: 提供完整的员工信息展示和筛选功能

### 技术目标
- 重建PostgreSQL全量索引
- 实现前端数据源标准化
- 建立实时数据同步机制
- 完善用户界面和交互体验

## 影响范围

### 前端组件
- `DepartmentMappingManager.tsx`: 部门映射管理组件
- `M1ServerManagement.tsx`: M1服务器管理组件
- `CrossSystemQuery.tsx`: 跨系统查询组件
- `DataSyncManager.tsx`: 数据同步管理组件

### 后端服务
- PostgreSQL数据库索引重建
- API路由优化
- WebSocket实时同步服务
- 缓存机制实现

### 数据库变更
- 全量索引重建
- 数据一致性验证
- 性能优化

## 技术实现方案

### 1. PostgreSQL全量索引重建
```sql
-- 重建部门人员索引
CREATE INDEX CONCURRENTLY idx_employees_department ON employees(department_id);
CREATE INDEX CONCURRENTLY idx_employees_name_search ON employees USING gin(to_tsvector('chinese', name));
CREATE INDEX CONCURRENTLY idx_departments_name_search ON departments USING gin(to_tsvector('chinese', name));
```

### 2. 前端数据源标准化
- 禁用虚拟文件数据源
- 实现基于SQL查询的缓存文件生成
- 建立定时刷新机制

### 3. 实时同步机制

#### WebSocket架构设计
**重要架构理解**: WebSocket连接是前端与后端服务器之间的连接，用于实时数据同步。前端与前端之间不直接通信，所有数据更新都通过PostgreSQL服务器进行协调。

#### 连接架构
```
前端客户端 <--WebSocket--> 后端服务器 <--SQL--> PostgreSQL数据库
     ↑                           ↑
     └─────── HTTP API ──────────┘
```

#### 实现细节
- **WebSocket服务器**: 运行在后端，监听端口8080，路径为`/data-sync/`
- **连接管理**: 使用Socket.IO库，支持自动重连和心跳检测
- **数据变更监听**: 监听数据库变更事件，通过WebSocket广播给所有连接的客户端
- **缓存自动更新**: 当数据库发生变更时，自动更新前端缓存并通知所有客户端刷新

#### 事件类型
- `sync-status`: 同步状态更新
- `data-changed`: 数据变更通知
- `sync-request`: 同步请求
- `force-sync`: 强制同步
- `consistency-check`: 一致性检查

### 4. 搜索功能增强
- 全文搜索支持
- 多部门并行查询
- 结果聚合和排序

## 开发规范

### 代码修改流程
1. **技术文档先行**: 每次修改前必须更新技术文档
2. **分步记录**: 确保每个操作步骤都可追溯
3. **问题标注**: 对重复出现但未彻底解决的问题，在rules文档中明确标注
4. **版本控制**: 严格按照Git版本管理规范进行提交

### 质量保证
- TypeScript类型检查
- 单元测试覆盖
- 集成测试验证
- 性能监控

## 风险评估

### 技术风险
- 数据库索引重建可能影响系统性能
- 大量数据迁移可能导致服务中断
- 前端缓存机制变更可能影响用户体验

### 缓解措施
- 使用CONCURRENTLY选项进行在线索引重建
- 分批次数据迁移
- 渐进式前端更新
- 完整的回滚方案

## 测试计划

### 功能测试
- 搜索功能全面测试
- 数据同步验证
- 工位管理功能测试

### 性能测试
- 数据库查询性能
- 前端加载速度
- 并发用户测试

### 兼容性测试
- 浏览器兼容性
- 移动端适配
- 数据格式兼容

## 部署计划

### 阶段一: 基础设施准备
- 数据库索引重建
- 缓存系统部署

### 阶段二: 后端服务更新
- API接口优化
- WebSocket服务升级

### 阶段三: 前端功能发布
- 搜索功能更新
- 工位管理增强

### 阶段四: 全面测试和优化
- 性能调优
- 用户反馈收集
- 问题修复

## 监控和维护

### 关键指标
- 搜索响应时间
- 数据同步延迟
- 系统可用性
- 用户满意度

### 告警机制
- 数据库性能监控
- API响应时间告警
- 数据一致性检查

## 文档维护

本文档将随着开发进度持续更新，确保技术实现与文档描述保持一致。每次重大变更都将记录在CHANGELOG.md中。

---

**文档负责人**: SOLO Coding  
**审核状态**: 待审核  
**下次更新**: 根据开发进度确定
