# Prometheus 告警规则配置
# 基于系统架构关联逻辑文档的告警策略

groups:
  # API 服务告警组
  - name: department-map-api-alerts
    rules:
      # API 服务不可用告警
      - alert: APIServiceDown
        expr: up{job="department-map-api"} == 0
        for: 1m
        labels:
          severity: critical
          service: api
        annotations:
          summary: "部门地图 API 服务不可用"
          description: "API 服务 {{ $labels.instance }} 已经停止响应超过 1 分钟"

      # API 响应时间过长告警
      - alert: APIHighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="department-map-api"}[5m])) > 2
        for: 5m
        labels:
          severity: warning
          service: api
        annotations:
          summary: "API 响应时间过长"
          description: "API 服务 {{ $labels.instance }} 的 95% 响应时间超过 2 秒，当前值: {{ $value }}s"

      # API 错误率过高告警
      - alert: APIHighErrorRate
        expr: rate(http_requests_total{job="department-map-api",status=~"5.."}[5m]) / rate(http_requests_total{job="department-map-api"}[5m]) > 0.05
        for: 3m
        labels:
          severity: warning
          service: api
        annotations:
          summary: "API 错误率过高"
          description: "API 服务 {{ $labels.instance }} 的错误率超过 5%，当前值: {{ $value | humanizePercentage }}"

      # API 请求量异常告警
      - alert: APIHighRequestRate
        expr: rate(http_requests_total{job="department-map-api"}[5m]) > 1000
        for: 2m
        labels:
          severity: warning
          service: api
        annotations:
          summary: "API 请求量异常"
          description: "API 服务 {{ $labels.instance }} 的请求量超过 1000 req/s，当前值: {{ $value }}"

  # WebSocket 连接告警组
  - name: websocket-alerts
    rules:
      # WebSocket 连接数过多告警
      - alert: WebSocketHighConnections
        expr: websocket_active_connections > 1000
        for: 2m
        labels:
          severity: warning
          service: websocket
        annotations:
          summary: "WebSocket 连接数过多"
          description: "WebSocket 活跃连接数超过 1000，当前值: {{ $value }}"

      # WebSocket 连接失败率过高告警
      - alert: WebSocketHighFailureRate
        expr: rate(websocket_connection_failures_total[5m]) / rate(websocket_connection_attempts_total[5m]) > 0.1
        for: 3m
        labels:
          severity: warning
          service: websocket
        annotations:
          summary: "WebSocket 连接失败率过高"
          description: "WebSocket 连接失败率超过 10%，当前值: {{ $value | humanizePercentage }}"

      # WebSocket 消息延迟过高告警
      - alert: WebSocketHighLatency
        expr: histogram_quantile(0.95, rate(websocket_message_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
          service: websocket
        annotations:
          summary: "WebSocket 消息延迟过高"
          description: "WebSocket 消息 95% 延迟超过 1 秒，当前值: {{ $value }}s"

  # 数据库告警组
  - name: postgresql-alerts
    rules:
      # PostgreSQL 服务不可用告警
      - alert: PostgreSQLDown
        expr: up{job="postgresql"} == 0
        for: 1m
        labels:
          severity: critical
          service: database
        annotations:
          summary: "PostgreSQL 数据库不可用"
          description: "PostgreSQL 数据库 {{ $labels.instance }} 已经停止响应超过 1 分钟"

      # 数据库连接数过多告警
      - alert: PostgreSQLHighConnections
        expr: pg_stat_database_numbackends / pg_settings_max_connections > 0.8
        for: 5m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "PostgreSQL 连接数过多"
          description: "PostgreSQL 连接数使用率超过 80%，当前值: {{ $value | humanizePercentage }}"

      # 数据库慢查询告警
      - alert: PostgreSQLSlowQueries
        expr: rate(pg_stat_database_tup_returned[5m]) / rate(pg_stat_database_tup_fetched[5m]) < 0.1
        for: 10m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "PostgreSQL 慢查询过多"
          description: "PostgreSQL 查询效率低下，返回行数与获取行数比例: {{ $value | humanizePercentage }}"

      # 数据库磁盘空间不足告警
      - alert: PostgreSQLDiskSpaceLow
        expr: (node_filesystem_avail_bytes{mountpoint="/var/lib/postgresql"} / node_filesystem_size_bytes{mountpoint="/var/lib/postgresql"}) < 0.1
        for: 5m
        labels:
          severity: critical
          service: database
        annotations:
          summary: "PostgreSQL 磁盘空间不足"
          description: "PostgreSQL 数据目录磁盘空间剩余不足 10%，当前值: {{ $value | humanizePercentage }}"

  # Redis 缓存告警组
  - name: redis-alerts
    rules:
      # Redis 服务不可用告警
      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
          service: cache
        annotations:
          summary: "Redis 缓存服务不可用"
          description: "Redis 缓存服务 {{ $labels.instance }} 已经停止响应超过 1 分钟"

      # Redis 内存使用率过高告警
      - alert: RedisHighMemoryUsage
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
        for: 5m
        labels:
          severity: warning
          service: cache
        annotations:
          summary: "Redis 内存使用率过高"
          description: "Redis 内存使用率超过 90%，当前值: {{ $value | humanizePercentage }}"

      # Redis 连接数过多告警
      - alert: RedisHighConnections
        expr: redis_connected_clients > 1000
        for: 5m
        labels:
          severity: warning
          service: cache
        annotations:
          summary: "Redis 连接数过多"
          description: "Redis 连接数超过 1000，当前值: {{ $value }}"

  # 系统资源告警组
  - name: system-alerts
    rules:
      # CPU 使用率过高告警
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "系统 CPU 使用率过高"
          description: "主机 {{ $labels.instance }} CPU 使用率超过 80%，当前值: {{ $value }}%"

      # 内存使用率过高告警
      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.9
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "系统内存使用率过高"
          description: "主机 {{ $labels.instance }} 内存使用率超过 90%，当前值: {{ $value | humanizePercentage }}"

      # 磁盘空间不足告警
      - alert: DiskSpaceLow
        expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.1
        for: 5m
        labels:
          severity: critical
          service: system
        annotations:
          summary: "磁盘空间不足"
          description: "主机 {{ $labels.instance }} 磁盘 {{ $labels.mountpoint }} 空间剩余不足 10%，当前值: {{ $value | humanizePercentage }}"

      # 磁盘 I/O 过高告警
      - alert: HighDiskIO
        expr: rate(node_disk_io_time_seconds_total[5m]) > 0.8
        for: 10m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "磁盘 I/O 使用率过高"
          description: "主机 {{ $labels.instance }} 磁盘 I/O 使用率超过 80%，当前值: {{ $value | humanizePercentage }}"

  # 网络告警组
  - name: network-alerts
    rules:
      # 网络连接数过多告警
      - alert: HighNetworkConnections
        expr: node_netstat_Tcp_CurrEstab > 10000
        for: 5m
        labels:
          severity: warning
          service: network
        annotations:
          summary: "网络连接数过多"
          description: "主机 {{ $labels.instance }} TCP 连接数超过 10000，当前值: {{ $value }}"

      # 网络流量异常告警
      - alert: HighNetworkTraffic
        expr: rate(node_network_receive_bytes_total[5m]) + rate(node_network_transmit_bytes_total[5m]) > 100000000
        for: 10m
        labels:
          severity: warning
          service: network
        annotations:
          summary: "网络流量异常"
          description: "主机 {{ $labels.instance }} 网络流量超过 100MB/s，当前值: {{ $value | humanize1024 }}B/s"

  # 前端服务告警组
  - name: frontend-alerts
    rules:
      # 前端服务不可用告警
      - alert: FrontendServiceDown
        expr: up{job=~"department-map-frontend|server-management-system"} == 0
        for: 2m
        labels:
          severity: warning
          service: frontend
        annotations:
          summary: "前端服务不可用"
          description: "前端服务 {{ $labels.job }} 在 {{ $labels.instance }} 已经停止响应超过 2 分钟"

  # Nginx 代理告警组
  - name: nginx-alerts
    rules:
      # Nginx 服务不可用告警
      - alert: NginxDown
        expr: up{job="nginx"} == 0
        for: 1m
        labels:
          severity: critical
          service: proxy
        annotations:
          summary: "Nginx 代理服务不可用"
          description: "Nginx 代理服务 {{ $labels.instance }} 已经停止响应超过 1 分钟"

      # Nginx 错误率过高告警
      - alert: NginxHighErrorRate
        expr: rate(nginx_http_requests_total{status=~"4..|5.."}[5m]) / rate(nginx_http_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          service: proxy
        annotations:
          summary: "Nginx 错误率过高"
          description: "Nginx 代理服务错误率超过 5%，当前值: {{ $value | humanizePercentage }}"