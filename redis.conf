# Redis配置文件 - 部门地图系统 v3.1.0
# 基于Redis 7.x版本优化配置

################################## 网络配置 ##################################

# 绑定地址
bind 0.0.0.0

# 端口配置
port 6379

# TCP监听队列长度
tcp-backlog 511

# 客户端超时时间（秒）
timeout 300

# TCP keepalive
tcp-keepalive 300

################################# 通用配置 #################################

# 守护进程模式
daemonize no

# 进程文件
pidfile /var/run/redis_6379.pid

# 日志级别
loglevel notice

# 日志文件
logfile ""

# 数据库数量
databases 16

# 显示Redis logo
always-show-logo no

# 设置服务器verbosity为'verbose'时是否记录所有查询
set-proc-title yes
proc-title-template "{title} {listen-addr} {server-mode}"

################################ 快照配置 ################################

# 自动保存配置
# 900秒内至少1个key发生变化
save 900 1
# 300秒内至少10个key发生变化
save 300 10
# 60秒内至少10000个key发生变化
save 60 10000

# 当RDB持久化出现错误后，是否依然进行工作
stop-writes-on-bgsave-error yes

# 使用压缩rdb文件
rdbcompression yes

# RDB文件校验
rdbchecksum yes

# RDB文件名
dbfilename dump.rdb

# RDB文件和AOF文件的存储目录
dir /data

################################# 复制配置 #################################

# 主从复制配置
# replica-serve-stale-data yes
# replica-read-only yes
# repl-diskless-sync no
# repl-diskless-sync-delay 5
# repl-diskless-load disabled
# repl-ping-replica-period 10
# repl-timeout 60
# repl-disable-tcp-nodelay no
# repl-backlog-size 1mb
# repl-backlog-ttl 3600

################################## 安全配置 ##################################

# 访问密码（生产环境必须设置）
# requirepass your_redis_password_here

# 重命名危险命令
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG "CONFIG_b840fc02d524045429941cc15f59e41cb7be6c52"
rename-command SHUTDOWN "SHUTDOWN_b840fc02d524045429941cc15f59e41cb7be6c52"
rename-command DEBUG ""
rename-command EVAL ""

# 保护模式
protected-mode no

################################### 客户端配置 ####################################

# 最大客户端连接数
maxclients 10000

################################## 内存管理 #################################

# 最大内存限制
maxmemory 2gb

# 内存淘汰策略
maxmemory-policy allkeys-lru

# LRU和LFU算法样本数
maxmemory-samples 5

# 副本忽略最大内存限制
replica-ignore-maxmemory yes

# 活跃重新哈希
activerehashing yes

# 客户端输出缓冲区限制
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# 客户端查询缓冲区限制
client-query-buffer-limit 1gb

# 协议最大批量请求大小
proto-max-bulk-len 512mb

################################ LUA脚本配置 ###############################

# Lua脚本最大执行时间（毫秒）
lua-time-limit 5000

################################## 慢日志配置 ###################################

# 慢查询日志记录时间阈值（微秒）
slowlog-log-slower-than 10000

# 慢查询日志最大长度
slowlog-max-len 128

################################ 延迟监控配置 ##############################

# 延迟监控阈值（毫秒）
latency-monitor-threshold 100

############################# 事件通知配置 ##############################

# 键空间通知配置
notify-keyspace-events "Ex"

############################### 高级配置 ###############################

# 哈希表配置
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# 列表配置
list-max-ziplist-size -2
list-compress-depth 0

# 集合配置
set-max-intset-entries 512

# 有序集合配置
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog配置
hll-sparse-max-bytes 3000

# 流配置
stream-node-max-bytes 4096
stream-node-max-entries 100

# 活跃重新哈希
activerehashing yes

# 客户端输出缓冲区硬限制和软限制
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# 频率
hz 10

# 动态频率
dynamic-hz yes

# AOF重写增量fsync
aof-rewrite-incremental-fsync yes

# RDB保存增量fsync
rdb-save-incremental-fsync yes

# LFU日志因子
lfu-log-factor 10

# LFU衰减时间
lfu-decay-time 1

############################# AOF持久化配置 #############################

# 启用AOF持久化
appendonly yes

# AOF文件名
appendfilename "appendonly.aof"

# AOF同步策略
# appendfsync always    # 每次写入都同步
appendfsync everysec    # 每秒同步一次（推荐）
# appendfsync no        # 不主动同步

# AOF重写期间是否同步
no-appendfsync-on-rewrite no

# AOF自动重写配置
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# AOF加载时是否忽略最后一条可能存在问题的指令
aof-load-truncated yes

# 混合持久化
aof-use-rdb-preamble yes

############################# 集群配置 #############################

# 启用集群模式（如果需要）
# cluster-enabled yes
# cluster-config-file nodes-6379.conf
# cluster-node-timeout 15000
# cluster-announce-ip 192.168.1.100
# cluster-announce-port 6379
# cluster-announce-bus-port 16379

############################ 模块配置 ############################

# 加载模块（如果需要）
# loadmodule /path/to/my_module.so
# loadmodule /path/to/other_module.so

############################ 性能优化配置 ############################

# 禁用THP（透明大页）
# echo never > /sys/kernel/mm/transparent_hugepage/enabled

# 内存分配器
# jemalloc 是Redis默认的内存分配器，性能较好

# TCP_NODELAY
tcp-nodelay yes

# 数据库数量（根据实际需要调整）
databases 16

############################ 监控配置 ############################

# 启用INFO命令的所有部分
# info-command-enabled yes

# 统计配置
tracking-table-max-keys 1000000

############################ 安全增强配置 ############################

# 禁用某些命令（生产环境推荐）
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command KEYS ""
# rename-command PEXPIRE ""
# rename-command DEL ""

# ACL配置（Redis 6.0+）
# user default on nopass ~* &* -@dangerous +@all
# user app_user on >app_password ~app:* +@read +@write -@dangerous

############################ 日志和调试配置 ############################

# 系统日志配置
syslog-enabled no
# syslog-ident redis
# syslog-facility local0

# 调试配置
# watchdog-period 0

############################ 网络优化配置 ############################

# SO_KEEPALIVE配置
tcp-keepalive 300

# 超时配置
timeout 300

# 连接队列长度
tcp-backlog 511

############################ 其他配置 ############################

# 是否启用保护模式
protected-mode no

# 绑定地址
bind 0.0.0.0

# 监听端口
port 6379

# 工作目录
dir /data

# 进程ID文件
pidfile /var/run/redis_6379.pid