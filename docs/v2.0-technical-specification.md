# 部门地图系统 v2.0 技术规范文档

## 1. 版本概述

### 1.1 修改背景
- **问题现象**: 当前系统仅能检索到技术部人员，其他部门人员在前端子地图可见但无法通过搜索功能查询
- **影响范围**: 搜索功能、数据同步、工位管理、前端展示
- **修改目的**: 建立完整的跨部门搜索功能，实现前端与数据库的严格同步

### 1.2 技术架构变更
```
旧架构: 前端 → 虚拟数据文件 → 部分索引
新架构: 前端 → 缓存文件 ← SQL查询 ← PostgreSQL全量索引
```

## 2. 代码修改流程规范

### 2.1 技术文档要求
- ✅ **完整上下文**: 每次修改必须包含背景、目的、影响范围
- ✅ **分步记录**: 确保每个操作步骤可追溯
- ✅ **问题标注**: 重复问题在rules文档中明确标注并设置提醒

### 2.2 版本管理规范
```bash
# 提交规范
git commit -m "feat(search): 重建PostgreSQL全量索引支持跨部门搜索"
git commit -m "fix(sync): 修复前端数据与数据库不同步问题"
git commit -m "docs(v2.0): 添加技术规范和修改流程文档"
```

### 2.3 代码质量标准
- TypeScript严格模式
- ESLint规则遵循
- 单元测试覆盖率 > 80%
- API文档完整性

## 3. 搜索功能异常修复方案

### 3.1 问题分析
```sql
-- 当前状态：仅技术部数据有效索引
SELECT department_name, COUNT(*) as employee_count 
FROM employees 
GROUP BY department_name;

-- 预期结果：所有部门都应有完整索引
-- 技术部: 5人
-- 人事部: 3人  
-- 产品部: 3人
-- 运营部: 3人
```

### 3.2 解决方案实施

#### 3.2.1 PostgreSQL全量索引重建
```sql
-- 1. 删除旧索引
DROP INDEX IF EXISTS idx_employees_search;
DROP INDEX IF EXISTS idx_employees_department;

-- 2. 创建新的复合索引
CREATE INDEX idx_employees_full_search ON employees 
USING gin(to_tsvector('chinese', name || ' ' || position || ' ' || email));

CREATE INDEX idx_employees_department_name ON employees(department_id, name);
CREATE INDEX idx_departments_name ON departments(name);
```

#### 3.2.2 搜索缓存系统
```typescript
// 缓存文件结构
interface SearchCache {
  employees: EmployeeSearchData[];
  departments: DepartmentData[];
  workstations: WorkstationData[];
  lastUpdated: string;
  version: string;
}
```

## 4. 数据同步问题处理

### 4.1 实时同步机制
```typescript
// WebSocket事件类型
type SyncEvent = 
  | 'employee_updated'
  | 'department_updated' 
  | 'workstation_updated'
  | 'cache_refreshed';

// 同步流程
1. 数据库变更 → 触发WebSocket事件
2. 前端接收事件 → 更新本地缓存
3. 缓存过期检查 → 自动刷新
4. 定时任务验证 → 数据一致性检查
```

### 4.2 数据一致性验证
```typescript
// 定时任务配置
const SYNC_INTERVALS = {
  CACHE_REFRESH: 5 * 60 * 1000,    // 5分钟
  CONSISTENCY_CHECK: 30 * 60 * 1000, // 30分钟
  FULL_REBUILD: 24 * 60 * 60 * 1000  // 24小时
};
```

## 5. M1服务器工位管理功能

### 5.1 数据要求
```typescript
interface WorkstationInfo {
  id: string;
  name: string;
  coordinates: { x: number; y: number };
  employee: {
    id: string;
    name: string;
    position: string;
    department: string;
  } | null;
  status: 'occupied' | 'available' | 'maintenance';
}
```

### 5.2 功能开发清单
- [x] 员工姓名展示
- [x] 工位编号显示
- [x] 坐标信息管理
- [ ] 部门筛选功能（管理员权限）
- [ ] 工位状态实时更新
- [ ] 批量操作支持

## 6. 系统校正标准

### 6.1 数据源规范
```typescript
// ❌ 禁止使用虚拟文件
const virtualData = require('./mock-data.json');

// ✅ 使用缓存文件
const cacheData = await getCachedSearchData();

// ✅ 直接SQL查询（实时数据）
const liveData = await db.query('SELECT * FROM employees_search_view');
```

### 6.2 缓存策略
```typescript
// 缓存更新策略
class SearchCacheManager {
  // 页面初次加载：使用缓存文件
  async getInitialData(): Promise<SearchCache>
  
  // 搜索操作：触发SQL查询并更新缓存
  async performSearch(query: string): Promise<SearchResult>
  
  // 定时刷新：后台更新缓存
  async refreshCache(): Promise<void>
}
```

## 7. API接口变更

### 7.1 搜索接口增强
```typescript
// 新增接口
POST /api/search-cache/refresh
GET  /api/search-cache/status
GET  /api/search-cache/stats

// 增强现有接口
GET /api/search?type=employees&department=all&query=张三
GET /api/search?type=departments&query=技术
GET /api/search?type=workstations&status=available
```

### 7.2 响应格式标准化
```typescript
interface APIResponse<T> {
  success: boolean;
  data: T;
  message?: string;
  timestamp: string;
  version: string;
  cached?: boolean;
}
```

## 8. 部署和维护

### 8.1 部署检查清单
- [ ] PostgreSQL索引重建完成
- [ ] 缓存目录权限配置
- [ ] WebSocket服务启动
- [ ] 定时任务配置
- [ ] 监控告警设置

### 8.2 监控指标
```typescript
interface SystemMetrics {
  searchPerformance: {
    avgResponseTime: number;
    cacheHitRate: number;
    errorRate: number;
  };
  dataConsistency: {
    lastSyncTime: string;
    inconsistencyCount: number;
    autoFixCount: number;
  };
  systemHealth: {
    dbConnectionStatus: 'healthy' | 'degraded' | 'down';
    cacheStatus: 'fresh' | 'stale' | 'missing';
    wsConnectionCount: number;
  };
}
```

## 9. 故障排查指南

### 9.1 常见问题
1. **搜索无结果**: 检查索引状态和缓存有效性
2. **数据不同步**: 验证WebSocket连接和定时任务
3. **性能问题**: 分析缓存命中率和SQL查询性能

### 9.2 日志分析
```bash
# 搜索性能日志
grep "search_performance" /var/log/department-map/api.log

# 数据同步日志  
grep "data_sync" /var/log/department-map/sync.log

# 错误日志
grep "ERROR" /var/log/department-map/*.log
```

---

**文档版本**: v2.0.0  
**最后更新**: 2024-01-XX  
**维护人员**: 开发团队  
**审核状态**: 待审核