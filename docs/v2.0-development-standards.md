# 部门地图系统 v2.0 开发规范

## 📋 概述

本文档定义了部门地图系统v2.0及以上版本的代码修改流程、开发规范和质量标准。所有开发人员必须严格遵循这些规范，确保代码质量和项目的可维护性。

## 🔄 代码修改流程规范

### 1. 技术文档与日志要求

#### 1.1 文档创建规范
- **完整上下文**: 创建新版本文档时必须包含完整的上下文信息
  - 修改背景和原因
  - 修改目的和预期效果
  - 影响范围和相关模块
  - 风险评估和回滚方案

#### 1.2 分步记录方式
- **操作可追溯**: 确保每个操作步骤都可追溯
  - 记录具体的文件修改
  - 记录配置变更
  - 记录数据库结构变化
  - 记录依赖包更新

#### 1.3 问题标注机制
- **重复问题管理**: 对重复出现但未彻底解决的问题
  - 在rules文档中明确标注
  - 设置提醒机制
  - 建立问题跟踪表
  - 定期回顾和解决

### 2. 版本控制规范

#### 2.1 分支管理
```bash
# 主分支
main/master     # 生产环境代码
develop         # 开发环境代码

# 功能分支
feature/功能名称  # 新功能开发
fix/问题描述     # 问题修复
hotfix/紧急修复  # 紧急修复
```

#### 2.2 提交规范
```bash
# 提交格式
<type>(<scope>): <subject>

<body>

<footer>

# 示例
feat(search): 实现全部门跨域搜索功能

- 添加多条件组合查询
- 优化搜索性能
- 修复技术部搜索限制问题

Closes #123
```

#### 2.3 提交类型
- `feat`: 新功能
- `fix`: 问题修复
- `docs`: 文档更新
- `style`: 代码格式
- `refactor`: 代码重构
- `perf`: 性能优化
- `test`: 测试相关
- `chore`: 构建工具

## 🏗️ 架构设计规范

### 1. 数据库设计规范

#### 1.1 多数据库支持
```typescript
// 数据库模式配置
interface DatabaseConfig {
  mode: 'postgresql' | 'sqlite' | 'memory';
  connection: ConnectionConfig;
  options: DatabaseOptions;
}

// 统一数据库接口
interface DatabaseInterface {
  query(sql: string, params?: any[]): Promise<any>;
  transaction(callback: Function): Promise<any>;
  testConnection(): Promise<boolean>;
  close(): Promise<void>;
}
```

#### 1.2 索引管理规范
- **全量索引**: 确保所有部门人员数据建立索引
- **搜索优化**: 为搜索字段建立复合索引
- **性能监控**: 定期检查索引使用情况
- **索引维护**: 定时重建和优化索引

### 2. 前端架构规范

#### 2.1 组件设计原则
- **单一职责**: 每个组件只负责一个功能
- **可复用性**: 提取公共组件和逻辑
- **性能优化**: 使用React.memo和useMemo
- **类型安全**: 严格的TypeScript类型定义

#### 2.2 状态管理规范
```typescript
// 使用Zustand进行状态管理
interface AppState {
  // 用户状态
  user: UserState;
  // 部门状态
  departments: DepartmentState;
  // 搜索状态
  search: SearchState;
  // UI状态
  ui: UIState;
}

// 状态更新规范
const useAppStore = create<AppState>((set, get) => ({
  // 状态定义
  user: initialUserState,
  
  // 动作定义
  actions: {
    updateUser: (user: User) => set({ user }),
    resetState: () => set(initialState),
  },
}));
```

### 3. 后端架构规范

#### 3.1 API设计规范
```typescript
// RESTful API规范
GET    /api/departments          # 获取部门列表
POST   /api/departments          # 创建部门
GET    /api/departments/:id      # 获取部门详情
PUT    /api/departments/:id      # 更新部门
DELETE /api/departments/:id      # 删除部门

// 响应格式规范
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: string;
  message?: string;
  timestamp: string;
}
```

#### 3.2 中间件规范
```typescript
// 认证中间件
export const authMiddleware = (req: Request, res: Response, next: NextFunction) => {
  // 验证JWT token
  // 设置用户信息
  // 权限检查
};

// 错误处理中间件
export const errorHandler = (err: Error, req: Request, res: Response, next: NextFunction) => {
  // 错误日志记录
  // 错误响应格式化
  // 错误监控上报
};
```

## 🔍 搜索功能规范

### 1. 搜索功能异常修复规范

#### 1.1 问题识别
- **现象描述**: 系统仅能检索到技术部人员
- **影响范围**: 其他部门（人事部、产品部、运营部）人员无法被搜索
- **根本原因**: 索引不完整，仅技术部数据建立了有效索引

#### 1.2 解决方案
```sql
-- 重建全量索引
DROP INDEX IF EXISTS idx_employees_search;
CREATE INDEX idx_employees_search ON employees 
USING gin(to_tsvector('chinese', name || ' ' || department || ' ' || position));

-- 验证索引覆盖
SELECT department, COUNT(*) as employee_count
FROM employees 
WHERE to_tsvector('chinese', name || ' ' || department || ' ' || position) @@ plainto_tsquery('chinese', '搜索词')
GROUP BY department;
```

#### 1.3 验证标准
- 所有部门人员均可被搜索到
- 搜索响应时间 < 500ms
- 搜索结果准确率 > 95%

### 2. 数据同步问题处理规范

#### 2.1 实时同步机制
```typescript
// WebSocket数据同步
class DataSyncService {
  private ws: WebSocket;
  
  // 监听数据变更
  onDataChange(type: string, data: any) {
    this.broadcast({
      type: 'DATA_SYNC',
      payload: { type, data },
      timestamp: Date.now()
    });
  }
  
  // 同步验证
  async validateSync(): Promise<boolean> {
    const frontendData = await this.getFrontendData();
    const backendData = await this.getBackendData();
    return this.compareData(frontendData, backendData);
  }
}
```

#### 2.2 缓存管理规范
```typescript
// 缓存文件生成
interface CacheConfig {
  source: 'sql' | 'api';
  ttl: number; // 缓存时间（秒）
  refreshTrigger: 'time' | 'event' | 'manual';
}

// 禁用虚拟文件
const FORBIDDEN_DATA_SOURCES = [
  'mock-data.json',
  'virtual-employees.js',
  'fake-departments.ts'
];
```

## 🖥️ M1服务器工位管理规范

### 1. 功能需求规范

#### 1.1 数据展示要求
```typescript
interface WorkstationDisplay {
  employeeName: string;      // 员工姓名
  workstationId: string;     // 工位编号
  coordinates: {             // 坐标信息
    x: number;
    y: number;
    floor: number;
  };
  status: 'occupied' | 'vacant' | 'maintenance'; // 工位状态
  department: string;        // 所属部门
  lastUpdated: Date;        // 最后更新时间
}
```

#### 1.2 部门筛选功能
```typescript
// 管理员权限验证
const checkAdminPermission = (user: User): boolean => {
  return user.role === 'admin' || user.permissions.includes('MANAGE_WORKSTATIONS');
};

// 多条件筛选
interface FilterCriteria {
  department?: string[];
  status?: WorkstationStatus[];
  floor?: number[];
  dateRange?: {
    start: Date;
    end: Date;
  };
}
```

### 2. 实时更新规范

#### 2.1 状态更新机制
```typescript
// 工位状态更新
class WorkstationManager {
  async updateStatus(id: string, status: WorkstationStatus) {
    // 1. 数据库更新
    await this.database.updateWorkstation(id, { status });
    
    // 2. 缓存更新
    await this.cache.invalidate(`workstation:${id}`);
    
    // 3. 实时通知
    this.websocket.broadcast('WORKSTATION_UPDATE', { id, status });
    
    // 4. 日志记录
    this.logger.info(`Workstation ${id} status updated to ${status}`);
  }
}
```

## 📊 系统校正标准

### 1. 数据源管理规范

#### 1.1 强制要求
- ✅ **必须使用**: SQL查询生成的缓存文件
- ❌ **禁止使用**: 虚拟文件作为数据源
- ✅ **缓存策略**: 页面初次加载使用缓存文件
- ✅ **实时更新**: 搜索操作触发新的SQL查询

#### 1.2 数据流规范
```typescript
// 数据流向
Database → SQL Query → Cache File → Frontend Display
         ↓
    Real-time Sync ← WebSocket ← Data Change Event
```

### 2. 性能标准

#### 2.1 响应时间要求
- 页面初次加载: < 2秒
- 搜索响应时间: < 500ms
- 数据同步延迟: < 100ms
- API响应时间: < 300ms

#### 2.2 并发处理能力
- 同时在线用户: > 100
- 并发搜索请求: > 50
- WebSocket连接数: > 200

## 🧪 测试规范

### 1. 测试覆盖率要求
- 单元测试覆盖率: > 80%
- 集成测试覆盖率: > 70%
- E2E测试覆盖率: > 60%

### 2. 测试类型规范

#### 2.1 单元测试
```typescript
// 组件测试
describe('DepartmentMappingManager', () => {
  it('should render employee list correctly', () => {
    // 测试组件渲染
  });
  
  it('should handle search functionality', () => {
    // 测试搜索功能
  });
});

// API测试
describe('Department API', () => {
  it('should return all departments', async () => {
    // 测试API响应
  });
});
```

#### 2.2 集成测试
```typescript
// 数据库集成测试
describe('Database Integration', () => {
  it('should sync data between frontend and backend', async () => {
    // 测试数据同步
  });
});
```

## 📝 代码质量标准

### 1. 代码规范
- **TypeScript**: 严格模式，完整类型定义
- **ESLint**: 遵循项目配置规则
- **Prettier**: 统一代码格式
- **注释**: 关键逻辑必须有注释

### 2. 性能优化
- **组件大小**: 单个组件 < 300行
- **函数复杂度**: 圈复杂度 < 10
- **包大小**: 单个包 < 100KB
- **内存使用**: 避免内存泄漏

### 3. 安全规范
- **输入验证**: 所有用户输入必须验证
- **SQL注入**: 使用参数化查询
- **XSS防护**: 输出内容转义
- **权限控制**: 严格的权限验证

## 🚀 部署规范

### 1. 环境配置
```bash
# 开发环境
NODE_ENV=development
DATABASE_MODE=memory
LOG_LEVEL=debug

# 测试环境
NODE_ENV=test
DATABASE_MODE=sqlite
LOG_LEVEL=info

# 生产环境
NODE_ENV=production
DATABASE_MODE=postgresql
LOG_LEVEL=error
```

### 2. 部署检查清单
- [ ] 环境变量配置正确
- [ ] 数据库连接测试通过
- [ ] 所有测试用例通过
- [ ] 性能指标达标
- [ ] 安全扫描通过
- [ ] 文档更新完成

## 📋 问题跟踪规范

### 1. 问题分类
- **P0**: 系统崩溃，影响所有用户
- **P1**: 核心功能异常，影响大部分用户
- **P2**: 部分功能异常，影响少数用户
- **P3**: 优化建议，不影响正常使用

### 2. 问题处理流程
1. **问题报告**: 详细描述问题现象
2. **问题分析**: 定位根本原因
3. **解决方案**: 制定修复计划
4. **测试验证**: 确认问题解决
5. **文档更新**: 更新相关文档
6. **经验总结**: 避免类似问题

## 📚 学习资源

### 1. 技术文档
- [React官方文档](https://react.dev/)
- [TypeScript手册](https://www.typescriptlang.org/docs/)
- [Node.js最佳实践](https://nodejs.org/en/docs/guides/)
- [PostgreSQL文档](https://www.postgresql.org/docs/)

### 2. 团队规范
- [Git工作流程](docs/git-workflow.md)
- [代码审查指南](docs/code-review.md)
- [API设计规范](docs/api-design.md)
- [数据库设计规范](docs/database-design.md)

---

**本规范文档将随着项目发展持续更新，所有团队成员都有责任遵循和完善这些规范。**