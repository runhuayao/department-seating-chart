# 更新日志

## [v1.1.0-M1] - 数据库架构升级版本 - 2024-01-16

### 🚀 重大架构升级
- 🏗️ 从静态数据(M0)升级到数据库架构(M1)，支持动态数据管理
- 🏗️ 实现渐进式迁移策略，确保M0组件接口完全兼容
- 🏗️ 建立完整的后端API服务架构，支持RESTful接口
- 🏗️ 创建PostgreSQL数据库设计，包含完整的表结构和关系

### 📊 数据适配层实现
- ✨ 创建`src/adapters/dataAdapter.ts` - 实现M0到M1数据格式适配
- ✨ 支持Employee和Desk数据结构的无缝转换
- ✨ 实现部门ID到名称的智能映射逻辑
- ✨ 确保现有组件无需修改即可使用新数据源

### 🔄 渐进式API迁移
- ✨ 创建`src/services/dataService.ts` - 混合数据源服务层
- ✨ 支持静态数据和API数据的智能切换
- ✨ 添加环境变量控制API使用开关
- ✨ 实现优雅降级机制，确保系统稳定性

### 🖥️ 后端API架构
- ✨ 完善Express服务器配置和中间件
- ✨ 实现完整的RESTful API路由结构：
  - `/api/departments` - 部门管理接口
  - `/api/employees` - 员工管理接口
  - `/api/desks` - 工位管理接口
  - `/api/status` - 状态管理接口
  - `/api/overview` - 概览数据接口
- ✨ 添加健康检查接口和错误处理机制
- ✨ 支持CORS和请求日志记录

### 🗄️ 数据库设计与迁移
- ✨ 设计完整的PostgreSQL数据库架构
- ✨ 创建核心表结构：departments、employees、desks、assignments
- ✨ 实现数据库迁移脚本系统
- ✨ 创建M0静态数据到M1数据库的自动迁移工具
- ✨ 添加数据完整性验证和质量检查

### 🛠️ 开发工具与脚本
- ✨ 创建数据库迁移管理工具 `scripts/migrate.js`
- ✨ 实现M0数据迁移工具 `scripts/migrateM0Data.js`
- ✨ 添加数据验证工具 `scripts/validateData.js`
- ✨ 创建数据库环境设置工具 `scripts/setupDatabase.js`
- ✨ 新增npm脚本命令支持一键部署和验证

### 📦 依赖管理
- 🔧 更新package.json版本至v1.1.0-M1
- 🔧 添加数据库相关依赖：pg、bcryptjs、jsonwebtoken
- 🔧 添加开发依赖：@types/pg、@types/bcryptjs等
- 🔧 新增数据库管理脚本命令

### 🔒 兼容性保证
- ✅ M0组件接口100%向后兼容
- ✅ 现有前端代码无需修改
- ✅ 支持渐进式升级，可随时回退到M0模式
- ✅ 数据格式完全兼容，确保平滑过渡

### 📋 新增脚本命令
```bash
# 数据库迁移
npm run db:migrate
npm run db:migrate-m0
npm run db:migrate-m0-force

# 数据验证
npm run db:validate

# 数据库设置
npm run db:setup
npm run db:setup-clean
npm run db:setup-schema-only
```

### 🎯 技术栈升级
- 🛠️ 后端：Express.js + TypeScript + PostgreSQL
- 🛠️ 数据层：原生SQL + 连接池管理
- 🛠️ 迁移：自定义迁移系统 + 数据验证
- 🛠️ 部署：支持Vercel无服务器部署

### 📁 新增文件结构
```
api/
├── app.ts              # Express应用配置
├── server.ts           # 本地开发服务器
├── index.ts            # Vercel部署入口
└── routes/             # API路由
    ├── auth.ts
    ├── departments.ts
    ├── employees.ts
    ├── desks.ts
    ├── status.ts
    └── overview.ts

src/
├── adapters/
│   └── dataAdapter.ts  # 数据适配层
└── services/
    └── dataService.ts  # 数据服务层

scripts/
├── migrate.js          # 数据库迁移工具
├── migrateM0Data.js    # M0数据迁移
├── validateData.js     # 数据验证
└── setupDatabase.js    # 数据库设置

migrations/
├── 001_create_base_tables.sql
└── 002_migrate_m0_data.sql
```

---

## [v1.0.4_M0] - 首页UI优化版本 - 2024-01-15

### 界面优化
- 🎨 简化首页部门概况显示，移除冗余的独立控制面板
- 🎨 优化首页模式下的部门卡片布局，提升视觉效果
- 🎨 精简部门统计信息展示，仅保留核心数据
- 🎨 改进首页响应式设计，提升多设备兼容性

### 代码优化
- 🔧 重构App.tsx中首页模式的渲染逻辑
- 🔧 移除冗余的UI组件和样式代码
- 🔧 优化组件结构，提升代码可维护性
- 🔧 简化状态管理，减少不必要的复杂度

### 用户体验提升
- ⚡ 提升首页加载性能，减少DOM元素数量
- ⚡ 优化交互流程，简化用户操作路径
- ⚡ 改进视觉层次，突出重要信息

### 技术改进
- 🛠️ 优化组件props传递，减少不必要的数据传递
- 🛠️ 改进CSS类名结构，提升样式可维护性
- 🛠️ 精简代码逻辑，提升运行效率

### 文件变更
- 📝 修改：`src/App.tsx` - 简化首页模式UI组件和逻辑

---

## [v1.0.3_M0] - SVG图例布局优化版本 - 2024-01-15

### 界面优化
- 🎨 调整SVG图例位置从右侧移至底部中央
- 🎨 优化图例布局为水平排列，提升空间利用率
- 🎨 解决图例与工位信息重叠的显示问题
- 🎨 改进图例响应式设计，适配不同屏幕尺寸

### 用户体验提升
- ⚡ 提升地图可读性，避免信息遮挡
- ⚡ 优化视觉层次，图例不再干扰主要内容
- ⚡ 改进整体布局平衡性

### 技术改进
- 🛠️ 优化DeptMap组件中图例定位逻辑
- 🛠️ 改进SVG布局计算，确保图例合理定位

### 文件变更
- 📝 修改：`src/components/DeptMap.tsx` - 调整图例布局和定位

---

## [v1.0.2_M0] - SVG显示优化版本 - 2024-01-15

### 界面优化
- 🎨 简化首页部门工位显示，移除独立div元素
- 🎨 实现SVG自适应缩放，解决超出div框架问题
- 🎨 优化工位信息完整显示，确保内容不被截断
- 🎨 改进首页总工位概况展示效果

### 功能增强
- ⚡ 实现SVG容器自适应缩放算法
- ⚡ 优化DeptMap组件的isHomepage模式处理
- ⚡ 简化首页控制面板显示逻辑

### 技术改进
- 🛠️ 优化SVG viewBox计算逻辑
- 🛠️ 改进响应式设计实现
- 🛠️ 提升组件渲染性能

### 文件变更
- 📝 修改：`src/components/DeptMap.tsx` - SVG缩放和首页模式优化
- 📝 修改：`src/App.tsx` - 首页显示逻辑简化

---

## [v1.0.1] - M0规范化修改 - 2024-01-15

### 新增功能
- ✨ 添加首页模式，支持网格化布局展示所有部门地图概览
- ✨ 实现部门数据完全隔离，确保部门切换时数据独立性
- ✨ 新增部门-员工映射表，确保员工ID唯一性
- ✨ 添加首页与部门详情页面的无缝切换功能

### 数据结构优化
- 🔧 重构员工ID与部门映射关系，确保每个员工ID唯一对应一个部门
- 🔧 创建标准化的数据管理模块 `departmentData.ts`
- 🔧 实现员工工位信息严格限定在所属部门范围内
- 🔧 添加数据一致性验证函数

### 界面改进
- 🎨 优化导航栏，添加首页按钮和改进的部门选择器
- 🎨 重新设计面包屑导航，支持首页和部门页面切换
- 🎨 首页采用响应式网格布局，支持多设备适配
- 🎨 部门卡片显示工位统计信息和快速访问按钮

### 功能增强
- ⚡ 部门切换时仅渲染当前部门员工工位，提升性能
- ⚡ 首页模式仅显示工位状态颜色标识，隐藏员工个人信息
- ⚡ 实现工位详情面板的动态数据绑定
- ⚡ 添加部门统计数据的实时计算

### 技术改进
- 🛠️ 使用TypeScript接口规范数据结构
- 🛠️ 实现模块化的数据管理和工具函数
- 🛠️ 优化组件props传递和状态管理
- 🛠️ 添加数据验证和错误处理机制

### 修复问题
- 🐛 修复部门切换时数据混乱的问题
- 🐛 解决员工ID跨部门重复分配的潜在风险
- 🐛 修复工位状态显示不准确的问题

### 文件变更
- 📁 新增：`src/data/departmentData.ts` - 统一数据管理模块
- 📝 修改：`src/components/DeptMap.tsx` - 重构地图组件逻辑
- 📝 修改：`src/App.tsx` - 添加首页模式和导航功能
- 📝 新增：`CHANGELOG.md` - 项目更新日志

### 数据完整性验证
- ✅ 员工ID唯一性验证通过
- ✅ 员工部门一致性验证通过
- ✅ 部门数据隔离验证通过
- ✅ 工位状态显示验证通过

---

## [v1.0.0] - 初始版本 - 2024-01-01

### 基础功能
- 🎯 部门地图可视化展示
- 🎯 工位状态管理（在线/离线）
- 🎯 员工信息显示
- 🎯 基础的部门切换功能

---

### 版本说明
- 🔢 版本号采用语义化版本控制 (Semantic Versioning)
- 📋 每个版本包含详细的功能变更说明
- 🎯 重要修改会标注影响范围和注意事项
- 📅 版本发布日期和修改摘要一并记录