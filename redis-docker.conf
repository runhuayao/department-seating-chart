# Redis Docker容器专用配置
# 部门地图系统 v3.2.0 - 生产环境优化

################################## 网络配置 ##################################

# 绑定地址 - 容器内监听所有接口
bind 0.0.0.0

# 端口配置
port 6379

# TCP监听队列长度
tcp-backlog 511

# 客户端超时时间（秒）
timeout 300

# TCP keepalive
tcp-keepalive 300

################################## 内存管理 ##################################

# 最大内存限制 - 优化为1GB以支持更大数据集
maxmemory 1gb

# 内存淘汰策略 - LRU算法淘汰所有键
maxmemory-policy allkeys-lru

# 内存采样数量 - 增加采样精度
maxmemory-samples 10

# 内存碎片整理
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100

################################## 连接管理 ##################################

# 最大客户端连接数 - 优化为2000以支持高并发
maxclients 2000

# 连接池优化
hz 10

# 客户端输出缓冲区限制
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

################################## 持久化配置 ##################################

# RDB持久化 - 优化数据快照策略
save 900 1      # 900秒内至少1个键变化
save 300 10     # 300秒内至少10个键变化
save 60 10000   # 60秒内至少10000个键变化
save 30 100000  # 30秒内至少100000个键变化 - 高频写入优化

# RDB文件名
dbfilename dump.rdb

# 工作目录
dir /data

# RDB文件压缩 - 启用LZF压缩
rdbcompression yes

# RDB校验和 - 启用数据完整性检查
rdbchecksum yes

# RDB保存失败时停止写入
stop-writes-on-bgsave-error yes

# AOF持久化 - 追加文件，双重保障
appendonly yes

# AOF文件名
appendfilename "appendonly.aof"

# AOF同步策略 - 每秒同步，平衡性能和安全
appendfsync everysec

# AOF重写触发条件 - 优化重写策略
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 128mb

# AOF加载时忽略最后不完整的命令
aof-load-truncated yes

# AOF重写时不进行fsync
no-appendfsync-on-rewrite no

################################## 日志配置 ##################################

# 日志级别
loglevel notice

# 日志文件 - 容器环境使用stdout
logfile ""

# 系统日志
syslog-enabled no

################################## 安全配置 ##################################

# 禁用危险命令
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG "CONFIG_9a8b7c6d5e4f3g2h1i"

# 保护模式 - 容器环境关闭
protected-mode no

################################## 性能优化 ##################################

# 哈希表优化
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# 列表优化
list-max-ziplist-size -2
list-compress-depth 0

# 集合优化
set-max-intset-entries 512

# 有序集合优化
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog优化
hll-sparse-max-bytes 3000

# 流优化
stream-node-max-bytes 4096
stream-node-max-entries 100

################################## 慢查询日志 ##################################

# 慢查询阈值（微秒）
slowlog-log-slower-than 10000

# 慢查询日志长度
slowlog-max-len 128

################################## 延迟监控 ##################################

# 延迟监控
latency-monitor-threshold 100

################################## 通知配置 ##################################

# 键空间通知
notify-keyspace-events "Ex"

################################## 高级配置 ##################################

# 数据库数量
databases 16

# Lua脚本超时时间
lua-time-limit 5000

# 集群模式 - 单机模式关闭
# cluster-enabled no

################################## 模块配置 ##################################

# 加载模块 - 根据需要启用
# loadmodule /path/to/module.so

################################## 容器优化 ##################################

# 后台运行 - 容器环境设为no
daemonize no

# PID文件 - 容器环境不需要
pidfile ""

# 监督模式 - 容器环境使用no
supervised no

# 内存过量使用 - 容器环境优化
vm-enabled no

################################## 部门地图系统专用配置 ##################################

# 工位缓存TTL优化
# 通过应用层控制，此处不设置默认过期

# 连接池优化 - 配合Node.js ioredis
# 通过客户端配置实现

# 实时同步优化
# 键空间通知已启用，支持WebSocket实时推送

################################## 监控和调试 ##################################

# 统计信息
# 通过INFO命令获取，无需额外配置

# 内存使用报告
# 通过MEMORY命令获取详细信息

################################## 备份和恢复 ##################################

# 自动备份通过Docker卷实现
# 手动备份使用BGSAVE命令

################################## 结束 ##################################